# BTS-0000035: YouTube ì—…ë¡œë“œ ì‹œ ì´ì¤‘ ë½ ì²´í¬ + dequeue race condition

**ë°œìƒì¼:** 2025-12-03

**ìƒíƒœ:** âœ… **í•´ê²°ë¨**

**ìš°ì„ ìˆœìœ„:** ğŸ”´ **CRITICAL** - YouTube ì—…ë¡œë“œ ì™„ì „ ë¶ˆê°€ (ë¸”ë¡œì»¤)

## ì¦ìƒ

- YouTube ì—…ë¡œë“œ ì‹œë„ ì‹œ í•­ìƒ ì‹¤íŒ¨
- ì—ëŸ¬ ë©”ì‹œì§€: "ì´ë¯¸ ì²˜ë¦¬ ì¤‘ì´ê±°ë‚˜ ì™„ë£Œëœ ì‘ì—…ì…ë‹ˆë‹¤ (í˜„ì¬ status: processing)"
- ë½ íšë“ ì‹¤íŒ¨ ë¡œê·¸ ë°˜ë³µ ë°œìƒ
- ê°™ì€ taskê°€ ë‘ ë²ˆ ì²˜ë¦¬ë˜ëŠ” race condition ë°œìƒ

```
[2025-12-03 02:08:00] âŒ ë½ íšë“ ì‹¤íŒ¨: í˜„ì¬ status=processing (ì´ë¯¸ ì²˜ë¦¬ ì¤‘ì´ê±°ë‚˜ ì™„ë£Œë¨)
[2025-12-03 02:08:00] âŒ ì—ëŸ¬: ì´ë¯¸ ì²˜ë¦¬ ì¤‘ì´ê±°ë‚˜ ì™„ë£Œëœ ì‘ì—…ì…ë‹ˆë‹¤ (í˜„ì¬ status: processing)
```

## ê·¼ë³¸ ì›ì¸

### ë¬¸ì œ 1: ì´ì¤‘ ë½ ì²´í¬

1. `dequeue()` (line 163-167)ì—ì„œ taskë¥¼ ê°€ì ¸ì˜¤ë©´ì„œ `status = 'processing'`ìœ¼ë¡œ ë³€ê²½
2. `processTask()` youtube ì²˜ë¦¬ (line 601-605)ì—ì„œ ë˜ ë‹¤ì‹œ `status = 'waiting'`ì¸ì§€ ì²´í¬í•˜ë©´ì„œ ë½ ì‹œë„
3. ì´ë¯¸ processing ìƒíƒœì´ë¯€ë¡œ ë½ íšë“ í•­ìƒ ì‹¤íŒ¨!

### ë¬¸ì œ 2: dequeue() race condition

ê¸°ì¡´ dequeue() ë¡œì§:
```javascript
// 1. SELECT (ì´ ì‹œì ì— ë‹¤ë¥¸ ì›Œì»¤ë„ ê°™ì€ task ì¡°íšŒ ê°€ëŠ¥!)
const task = await getOne(`SELECT * FROM task_queue WHERE status = 'waiting' ...`);
// 2. UPDATE (ë‘˜ ë‹¤ ê°™ì€ taskë¥¼ processingìœ¼ë¡œ ë³€ê²½ ì‹œë„)
await run(`UPDATE task_queue SET status = 'processing' WHERE task_id = ?`);
```

SELECTì™€ UPDATE ì‚¬ì´ì— race condition ì¡´ì¬ â†’ ë‘ ì›Œì»¤ê°€ ê°™ì€ task ì²˜ë¦¬ ì‹œë„

## ìˆ˜ì • ë°©ë²•

### ìˆ˜ì • 1: processTask() ì´ì¤‘ ë½ ì²´í¬ ì œê±°

```javascript
} else if (type === 'youtube') {
  // BTS-0000035: dequeue()ì—ì„œ ì´ë¯¸ status='processing'ìœ¼ë¡œ ë³€ê²½í–ˆìœ¼ë¯€ë¡œ ì´ì¤‘ ë½ ì²´í¬ ì œê±°
  console.log(`${emoji} [${type}] ğŸ”’ ë½ í™•ì¸: dequeue()ì—ì„œ ì´ë¯¸ processing ìƒíƒœë¡œ ë³€ê²½ë¨`);
  this.runningYoutubeUploads.set(taskId, Date.now());
  // ...
}
```

### ìˆ˜ì • 2: dequeue() Atomic ì²˜ë¦¬ (SELECT FOR UPDATE)

```javascript
async dequeue(type) {
  // SELECT FOR UPDATE SKIP LOCKEDë¡œ row lock íšë“
  const task = await getOne(`
    SELECT * FROM task_queue
    WHERE type = ? AND status = 'waiting'
    ORDER BY created_at ASC
    LIMIT 1
    FOR UPDATE SKIP LOCKED
  `, [type]);

  if (!task) return null;

  // ìƒíƒœë¥¼ processingìœ¼ë¡œ ë³€ê²½ (ê°™ì€ task_id, status=waiting ì¡°ê±´)
  const updateResult = await run(`
    UPDATE task_queue
    SET status = 'processing'
    WHERE task_id = ? AND type = ? AND status = 'waiting'
  `, [task.task_id, type]);

  // ë‹¤ë¥¸ ì›Œì»¤ê°€ ë¨¼ì € ê°€ì ¸ê°”ìœ¼ë©´ ì‹¤íŒ¨
  if (updateResult.affectedRows === 0) {
    console.log(`âš ï¸ [${type}] Task ${task.task_id} already taken by another worker`);
    return null;
  }
  // ...
}
```

## ìˆ˜ì •ëœ íŒŒì¼

1. `trend-video-frontend/src/workers/unified-worker.js:151-178`
   - dequeue()ì— SELECT FOR UPDATE SKIP LOCKED ì ìš©
   - UPDATE ì‹œ status='waiting' ì¡°ê±´ ì¶”ê°€ë¡œ ì´ì¤‘ ë³´í˜¸

2. `trend-video-frontend/src/workers/unified-worker.js:597-604`
   - processTask() youtube ì´ì¤‘ ë½ ì²´í¬ ë¡œì§ ì œê±°

## ì¬ë°œ ë°©ì§€

- `dequeue()`ì—ì„œ atomicí•˜ê²Œ ì²˜ë¦¬í•˜ë¯€ë¡œ ê°œë³„ íƒ€ì…ì—ì„œ ë‹¤ì‹œ ë½ ì²´í¬ ë¶ˆí•„ìš”
- MySQL `FOR UPDATE SKIP LOCKED` ì‚¬ìš©ìœ¼ë¡œ row-level locking
- UPDATE ì‹œ `WHERE status = 'waiting'` ì¡°ê±´ìœ¼ë¡œ ì´ì¤‘ ë³´í˜¸

## ê´€ë ¨ BTS

- BTS-0000026: DB ë½ìœ¼ë¡œ ì¤‘ë³µ ì—…ë¡œë“œ ë°©ì§€ (ì´ ë²„ê·¸ì˜ ì›ì¸ì´ ëœ ìˆ˜ì •)
- BTS-0000033: ì¬ì‹œë„ ë²„íŠ¼ status ë¬¸ì œ (ìœ ì‚¬í•œ ë½ ê´€ë ¨ ë²„ê·¸)
