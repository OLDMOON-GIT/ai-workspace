# 씬 처리 로직 통합 테스트 가이드

## 개요

이미지+비디오 혼합 처리를 지원하는 통합 씬 처리 파이프라인이 완성되었습니다.

**구현 내용:**
- Backend: `_continue_from_media()` 함수로 이미지/비디오 통합 처리
- Backend: `_sort_scenes()` - seq → created_at → 원래 순서로 정렬
- Frontend: Scene 타입 정의 추가 (seq, created_at)
- Backend 테스트: 32개 리그레션 테스트 모두 통과 ✅

---

## 테스트 시나리오

### 1. 이미지만 (기존 방식)

**테스트 방법:**
1. Frontend에서 스크립트 생성 또는 JSON 업로드
2. 이미지만 포함된 씬 데이터 생성
3. 비디오 생성 API 호출

**예상 동작:**
- 각 씬의 이미지가 비디오로 변환됨 (image-to-video)
- TTS 오디오 생성 → 이미지+오디오 결합 → 자막 추가
- 모든 씬 병합

**검증 포인트:**
- [ ] 이미지가 올바른 순서로 처리되는지
- [ ] TTS가 정상 생성되는지
- [ ] 자막이 정확한 타이밍에 표시되는지

---

### 2. 비디오만 (비디오 병합)

**테스트 방법:**
1. Frontend 비디오 병합 페이지에서 비디오 파일들 업로드
2. JSON 파일에 씬 정보 포함 (선택사항)
3. 병합 시작

**예상 동작:**
- 업로드된 비디오에 오디오 추가 (기존 비디오는 유지)
- 비디오 길이 < 오디오 길이 → 비디오 루핑
- 비디오 길이 > 오디오 길이 → 비디오 트리밍
- 자막 추가

**검증 포인트:**
- [ ] 비디오가 올바른 순서로 병합되는지
- [ ] 오디오가 정확히 동기화되는지
- [ ] 루핑/트리밍이 정상 작동하는지

---

### 3. 이미지 + 비디오 혼합 ⭐ (NEW)

**테스트 방법:**

#### 방법 A: JSON 직접 작성
```json
{
  "title": "혼합 테스트",
  "scenes": [
    {
      "scene_number": 1,
      "title": "오프닝",
      "narration": "안녕하세요, 첫 번째 씬입니다.",
      "seq": 1
    },
    {
      "scene_number": 2,
      "title": "메인",
      "narration": "두 번째 씬입니다.",
      "seq": 2
    },
    {
      "scene_number": 3,
      "title": "엔딩",
      "narration": "세 번째 씬입니다.",
      "seq": 3
    }
  ]
}
```

그 후 일부 씬 폴더에는 이미지만, 일부에는 비디오만 넣기:
```
project_xxx/
  scene_01/
    scene_01_image.png  ← 이미지만
  scene_02/
    scene_02_video.mp4  ← 비디오만
  scene_03/
    scene_03_image.png  ← 이미지만
```

#### 방법 B: 비디오 병합 + JSON
1. 비디오 2개 업로드
2. JSON에 3개 씬 정의 (씬 수 > 비디오 수)
3. Backend가 부족한 씬은 이미지 생성으로 처리

**예상 동작:**
- Backend가 각 씬 폴더를 스캔
- 비디오 발견 → 기존 비디오에 오디오+자막 추가
- 이미지 발견 → 이미지→비디오 변환
- 통합 파이프라인으로 모두 처리

**검증 포인트:**
- [ ] 이미지 씬과 비디오 씬이 올바른 순서로 병합되는지
- [ ] 각 씬의 미디어 타입이 정확히 감지되는지
- [ ] 로그에 🎬 (비디오), 🖼️ (이미지) 아이콘이 표시되는지

---

## 정렬 우선순위 테스트

### seq 우선순위 1
```json
{
  "scenes": [
    {"seq": 3, "title": "C", "created_at": "2025-01-10T10:00:00Z"},
    {"seq": 1, "title": "A", "created_at": "2025-01-10T20:00:00Z"},
    {"seq": 2, "title": "B", "created_at": "2025-01-10T15:00:00Z"}
  ]
}
```
**예상 순서:** A → B → C (seq 우선)

### created_at 우선순위 2
```json
{
  "scenes": [
    {"title": "C", "created_at": "2025-01-10T20:00:00Z"},
    {"title": "A", "created_at": "2025-01-10T10:00:00Z"},
    {"title": "B", "created_at": "2025-01-10T15:00:00Z"}
  ]
}
```
**예상 순서:** A → B → C (created_at 순서)

### 혼합
```json
{
  "scenes": [
    {"seq": 1, "title": "A"},
    {"created_at": "2025-01-10T15:00:00Z", "title": "C"},
    {"seq": 2, "title": "B"},
    {"created_at": "2025-01-10T10:00:00Z", "title": "D"}
  ]
}
```
**예상 순서:** A → B → D → C (seq 먼저, 그 다음 created_at)

---

## 검증 방법

### Backend 로그 확인
```
생성된 미디어 목록:
  - Scene 01: 🖼️  scene_01_image.png
  - Scene 02: 🎬 scene_02_video.mp4
  - Scene 03: 🖼️  scene_03_image.png
```

### 프로세스 로그 확인
```
[Step 2-C] Creating Videos for 3 Scenes... (병렬 처리)
   🖼️  Scene 1: 이미지→비디오 변환 중...
   🎬 Scene 2: 비디오 발견! 오디오+자막 추가 중...
   🖼️  Scene 3: 이미지→비디오 변환 중...
```

### 최종 비디오 확인
- [ ] 모든 씬이 올바른 순서로 병합됨
- [ ] 오디오가 정확히 동기화됨
- [ ] 자막이 정확한 타이밍에 표시됨
- [ ] 화질 저하 없음
- [ ] 씬 전환이 자연스러움

---

## 리그레션 테스트 실행

### Backend
```bash
cd trend-video-backend
python -m pytest tests/test_scene_processing.py -v
```

**결과:** 32 tests passed ✅

**테스트 범위:**
- 씬 정렬 로직 (6 tests)
- 미디어 타입 감지 (4 tests)
- Scene media 구조 (4 tests)
- 비디오 길이 매칭 (4 tests)
- 혼합 미디어 처리 (4 tests)
- 엣지 케이스 (5 tests)
- 리그레션 버그 방지 (5 tests)

---

## 알려진 제한사항

1. **씬 수와 비디오 수 불일치**
   - 비디오가 씬보다 많으면: 남는 비디오 무시
   - 씬이 비디오보다 많으면: 부족한 씬은 이미지 생성

2. **파일 형식**
   - 지원: `.mp4`, `.avi`, `.mov`, `.mkv` (비디오)
   - 지원: `.png`, `.jpg`, `.jpeg`, `.webp` (이미지)

3. **성능**
   - 비디오 처리가 이미지 처리보다 빠름 (변환 과정 생략)
   - 병렬 처리로 최적화됨 (최대 3개 동시)

---

## 커밋 히스토리

### Backend
- `3940ae6` - feat: 씬 처리 로직 통합 - 이미지+비디오 혼합 지원
- `b8ca695` - test: 씬 처리 로직 통합 리그레션 테스트 추가 (32 tests)
- `ec7b364` - chore: backend 서브모듈 업데이트 - 씬 처리 로직 통합
- `d50677d` - chore: backend 서브모듈 업데이트 - 씬 처리 테스트 추가

### Frontend
- `99986ed` - feat: Scene 타입 정의 및 created_at 필드 추가

---

## 다음 단계

1. **실제 비디오로 통합 테스트**
   - 이미지만
   - 비디오만
   - 혼합

2. **UI 개선 (선택사항)**
   - 씬 순서 조정 기능
   - 미디어 타입 표시 아이콘
   - seq 필드 수동 입력

3. **문서화**
   - 사용자 가이드 작성
   - API 문서 업데이트

---

## 문의

문제 발생 시:
1. Backend 로그 확인 (`trend-video-backend/logs/`)
2. 리그레션 테스트 재실행
3. GitHub Issues 제출
