# BTS-0000012: ì¤‘ê°„ ë‹¨ê³„ì—ì„œ task_queue.status='completed' ì„¤ì •ë˜ëŠ” ë¬¸ì œ (completed ëŒ€ë€)

**ë°œìƒì¼:** 2025-12-02

**ìƒíƒœ:** âœ… í•´ê²°ë¨

**ì‹¬ê°ë„:** ğŸ”´ **CRITICAL** - ì›Œí¬í”Œë¡œìš° ìƒíƒœ ê´€ë¦¬ ì‹¤íŒ¨

**ì¦ìƒ:**
- script, image, video ë‹¨ê³„ ì™„ë£Œ ì‹œ task_queue.statusê°€ 'completed'ë¡œ ì„¤ì •ë¨
- youtube ë‹¨ê³„ë§Œ 'completed'ì—¬ì•¼ í•˜ëŠ”ë° ëª¨ë“  ì¤‘ê°„ ë‹¨ê³„ê°€ 'completed'

**ì‹¤ì œ ë°ì´í„° (2025-12-02 22:31 ê¸°ì¤€):**
```
script  + completed: 4ê°œ âš ï¸ (034828d5, 50171a47, 239a03e0, 80350e3f)
image   + completed: 2ê°œ âš ï¸ (525fd4a5, 77fb7660)
video   + completed: 2ê°œ âš ï¸ (4368907f, 676fc239)
```

**ì˜¬ë°”ë¥¸ ìŠ¤í™:**
```
âœ… script ì™„ë£Œ â†’ triggerNextStage â†’ task_queue: type='image', status='waiting'
âœ… image ì™„ë£Œ â†’ triggerNextStage â†’ task_queue: type='video', status='waiting'
âœ… video ì™„ë£Œ â†’ triggerNextStage â†’ task_queue: type='youtube', status='waiting'
âŒ youtube ì™„ë£Œ â†’ updateTask â†’ task_queue: status='completed' (ìœ ì¼í•˜ê²Œ completed ì„¤ì •)
```

**í˜„ì¬ ì½”ë“œ (unified-worker.js:294-304):**
```javascript
const hasNextStage = await this.triggerNextStage(type, taskId, emoji);

if (hasNextStage) {
  // âœ… script/image/videoëŠ” ì—¬ê¸°ë¡œ ì˜´ (completed ì„¤ì • ì•ˆ í•¨)
  console.log(`${emoji} [${type}] âœ… Completed and moved to next stage: ${taskId}`);
} else {
  // âœ… youtubeë§Œ ì—¬ê¸°ë¡œ ì˜´
  await this.updateTask(taskId, type, {
    state: 'completed'
  });
  console.log(`${emoji} [${type}] âœ… All stages completed: ${taskId}`);
}
```

**ì½”ë“œëŠ” ì˜¬ë°”ë¥¸ë° ì‹¤ì œë¡œëŠ” ë¬¸ì œ ë°œìƒ!**

**ê°€ëŠ¥í•œ ì›ì¸:**
1. **ì›Œì»¤ê°€ ì¬ì‹œì‘ë˜ì§€ ì•Šì•„ì„œ ì´ì „ ë²„ì „ ì½”ë“œë¡œ ì‹¤í–‰ ì¤‘**
2. **ë‹¤ë¥¸ ê³³ì—ì„œ completedë¥¼ ì„¤ì •í•˜ëŠ” ë¡œì§ì´ ìˆìŒ** (API, ìŠ¤ì¼€ì¤„ëŸ¬ ë“±)
3. **ì½”ë“œê°€ gitì—ì„œ ë˜ëŒì•„ê°** (unlikely but possible)
4. **í…ŒìŠ¤íŠ¸ëŠ” ìƒˆ ì½”ë“œ, ì‹¤ì œ ì›Œì»¤ëŠ” êµ¬ ì½”ë“œ ì‹¤í–‰ ì¤‘**

**ì™œ í…ŒìŠ¤íŠ¸ëŠ” í†µê³¼í–ˆëŠ”ê°€:**
- test-worker-flow.mjsëŠ” ìƒˆë¡œìš´ ì½”ë“œë¡œ ì‹¤í–‰ë¨
- í•˜ì§€ë§Œ ì‹¤ì œ production ì›Œì»¤ëŠ” ì¬ì‹œì‘ë˜ì§€ ì•Šì•„ì„œ ì´ì „ ì½”ë“œë¡œ ì‹¤í–‰ ì¤‘ì¼ ê°€ëŠ¥ì„±

**ê·¼ë³¸ ì›ì¸ (2025-12-02 23:00 ìµœì¢… í™•ì¸):**

### ğŸ› ë²„ê·¸ #1: triggerNextStage ì—ëŸ¬ ì‹œ completed ì²˜ë¦¬
**ë¬¸ì œ ì½”ë“œ** (`unified-worker.js` line 618-621):
```javascript
} catch (error) {
  console.error(`${emoji} [${currentType}] Failed to trigger next stage:`, error);
  return false;  // âš ï¸ ì—ëŸ¬ ë°œìƒ ì‹œ false ë°˜í™˜!
}
```

**ë¬¸ì œ ì‹œë‚˜ë¦¬ì˜¤:**
1. script ì™„ë£Œ í›„ `triggerNextStage` í˜¸ì¶œ
2. DB ì—ëŸ¬ ë°œìƒ (ì˜ˆ: content UPDATE ì‹¤íŒ¨)
3. catchì—ì„œ **return false** ë°˜í™˜
4. `hasNextStage = false` íŒì •
5. **line 300-302ì—ì„œ completed ì„¤ì •!** âŒ

**ì¦‰, ì—ëŸ¬ê°€ ë°œìƒí•˜ë©´ completedë¡œ ì²˜ë¦¬ë˜ëŠ” ì‹¬ê°í•œ ë²„ê·¸!**

### ğŸ› ë²„ê·¸ #2: content.statusë¥¼ ë‹¤ìŒ typeìœ¼ë¡œ ì„¤ì •
**ë¬¸ì œ ì½”ë“œ** (`unified-worker.js` line 601-606):
```javascript
// âŒ ì˜ëª»: ë‹¤ìŒ typeìœ¼ë¡œ ì„¤ì •
await run(`
  UPDATE content
  SET status = ?
  WHERE content_id = ?
`, [nextType, taskId]);
```

**ì˜¬ë°”ë¥¸ ê·œì¹™ (ì‚¬ìš©ì í‘œ):**
| ì™„ë£Œ ë‹¨ê³„ | content.status ë³€ê²½ |
|----------|------------------|
| script | 'script' (í˜„ì¬ type) |
| image | ë³€ê²½ ì•ˆ í•¨ (script ìœ ì§€) |
| video | 'video' (í˜„ì¬ type) |
| youtube | 'completed' |

### ğŸ› ë²„ê·¸ #3: youtube ì™„ë£Œ ì‹œ content.status ëˆ„ë½
**ë¬¸ì œ ì½”ë“œ** (`unified-worker.js` line 300-302):
```javascript
// âŒ task_queueë§Œ completedë¡œ ë³€ê²½
await this.updateTask(taskId, type, {
  state: 'completed'
});
// content.statusëŠ” ë³€ê²½ ì•ˆ í•¨!
```

**ê²°ê³¼:** content.statusê°€ 'video'ë¡œ ë‚¨ì•„ìˆìŒ!

---

### âœ… í•´ê²° ë°©ë²•

**1. triggerNextStage ì—ëŸ¬ ì²˜ë¦¬** (line 618-622):
```javascript
} catch (error) {
  console.error(`${emoji} [${currentType}] Failed to trigger next stage:`, error);
  // âœ… ì—ëŸ¬ë¥¼ throwí•˜ì—¬ ìƒìœ„ì—ì„œ failedë¡œ ì²˜ë¦¬
  throw error;
}
```

**2. content.status ì„¤ì • ê·œì¹™** (line 601-610):
```javascript
// âœ… script/video ì™„ë£Œ ì‹œë§Œ í˜„ì¬ typeìœ¼ë¡œ ì„¤ì •
if (currentType === 'script' || currentType === 'video') {
  await run(`
    UPDATE content
    SET status = ?
    WHERE content_id = ?
  `, [currentType, taskId]);
}
// image ì™„ë£Œ ì‹œì—ëŠ” content.status ë³€ê²½ ì•ˆ í•¨ (script ìƒíƒœ ìœ ì§€)
```

**3. youtube ì™„ë£Œ ì‹œ content.status ì„¤ì •** (line 300-310):
```javascript
} else {
  // ë§ˆì§€ë§‰ ë‹¨ê³„ (youtube)ë§Œ completed ìƒíƒœë¡œ ë³€ê²½
  // 1. task_queue
  await this.updateTask(taskId, type, {
    state: 'completed'
  });
  // 2. content.statusë„ 'completed'ë¡œ ì„¤ì •
  await run(`
    UPDATE content
    SET status = 'completed'
    WHERE content_id = ?
  `, [taskId]);
  console.log(`${emoji} [${type}] âœ… All stages completed: ${taskId}`);
}
```

---

### ğŸ” ê²€ì¦ ë°©ë²•

**1. ê¸°ì¡´ ì˜ëª»ëœ completed ë ˆì½”ë“œ ì •ë¦¬:**
```sql
DELETE FROM task_queue
WHERE type IN ('script', 'image', 'video') AND status = 'completed';
```

**2. ì›Œì»¤ ì¬ì‹œì‘:**
```bash
cd C:\Users\oldmoon\workspace\trend-video-frontend
npm run stop:unified-worker
npm run start:unified-worker
```

**3. ìƒˆë¡œìš´ ì‘ì—… ì‹¤í–‰ í›„ í™•ì¸:**
```sql
SELECT type, status, COUNT(*) as count
FROM task_queue
GROUP BY type, status;

-- âœ… youtube completedë§Œ ìˆì–´ì•¼ í•¨
-- âŒ script/image/video completedê°€ ìƒê¸°ë©´ ë²„ê·¸ ì¬ë°œ
```

**ì¬ë°œ ë°©ì§€:**
1. **ì—ëŸ¬ ì²˜ë¦¬ ê·œì¹™:**
   - ìƒíƒœ ì „í™˜ ì‹¤íŒ¨ ì‹œ false ë°˜í™˜ ê¸ˆì§€
   - ë°˜ë“œì‹œ throwí•˜ì—¬ ìƒìœ„ì—ì„œ failedë¡œ ì²˜ë¦¬

2. **ìƒíƒœ ê´€ë¦¬ ê·œì¹™:**
   - ì¤‘ê°„ ë‹¨ê³„(script/image/video)ëŠ” ì ˆëŒ€ completed ì„¤ì • ê¸ˆì§€
   - youtubeë§Œ ìœ ì¼í•˜ê²Œ completed ì„¤ì •

3. **content.status ê·œì¹™:**
   - script ì™„ë£Œ â†’ 'script'
   - image ì™„ë£Œ â†’ ë³€ê²½ ì•ˆ í•¨
   - video ì™„ë£Œ â†’ 'video'
   - youtube ì™„ë£Œ â†’ 'completed'

4. **ì½”ë“œ ë¦¬ë·° ì‹œ í™•ì¸ì‚¬í•­:**
   - `state: 'completed'` ê²€ìƒ‰í•˜ì—¬ youtube ì™¸ ì‚¬ìš© ê¸ˆì§€
   - `return false` ê²€ìƒ‰í•˜ì—¬ ì—ëŸ¬ ì²˜ë¦¬ í™•ì¸
   - content.statusì™€ task_queue.status ë™ì‹œ ì—…ë°ì´íŠ¸ í™•ì¸

---
