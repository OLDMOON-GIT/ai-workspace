# BTS-0000016: video ë‹¨ê³„ë¥¼ completedë¡œ ì˜ëª» ì„¤ì •

**ë°œìƒì¼:** 2025-12-02

**ìƒíƒœ:** âœ… **í•´ê²°ë¨**

**ì‹¬ê°ë„:** ğŸ”´ **CRITICAL** - ìƒíƒœ í”Œë¡œìš° ìœ„ë°˜

**ì¦ìƒ:**
- video ì™„ë£Œ í›„ task_queue.statusê°€ 'completed'ë¡œ ì„¤ì •ë¨
- ì˜¬ë°”ë¥¸ í”Œë¡œìš°: video ì™„ë£Œ â†’ type='youtube', status='**waiting**'
- ì˜ëª»ëœ ë™ì‘: video ì™„ë£Œ â†’ status='**completed**'

**ì‚¬ë¡€:** Task ID: `6cadc518-f561-42bd-b60d-7b2b695e1bc3`

**ì˜¬ë°”ë¥¸ ìŠ¤í™ (í‘œ ê¸°ì¤€):**
```
video ì™„ë£Œ â†’ content.status = 'video'
           â†’ task_queue: type='youtube', status='waiting'
```

**ê·¼ë³¸ ì›ì¸:**

### âš ï¸ Worker í”„ë¡œì„¸ìŠ¤ê°€ ì¬ì‹œì‘ë˜ì§€ ì•Šì•„ì„œ ì´ì „ ì½”ë“œê°€ ì‹¤í–‰ ì¤‘

**ë¬¸ì œ ì‹œë‚˜ë¦¬ì˜¤:**
1. video ë‹¨ê³„ ì™„ë£Œ
2. triggerNextStage('video') í˜¸ì¶œ
3. DB UPDATE ì‹œë„ ì¤‘ ì—ëŸ¬ ë°œìƒ
4. catchì—ì„œ `return false` ì‹¤í–‰ (ì´ì „ ì½”ë“œ)
5. `hasNextStage = false` íŒì •
6. video completed ì²˜ë¦¬ âŒ

**ì½”ë“œëŠ” ì´ë¯¸ ìˆ˜ì •ë˜ì–´ ìˆì—ˆìŒ:**
- unified-worker.js Line 635: `throw error;` (ì´ë¯¸ ì ìš©ë¨)
- í•˜ì§€ë§Œ ì›Œì»¤ê°€ ì¬ì‹œì‘ë˜ì§€ ì•Šì•„ì„œ ë©”ëª¨ë¦¬ì— ì´ì „ ì½”ë“œê°€ ë¡œë“œë˜ì–´ ìˆìŒ

---

## âœ… í•´ê²° ì™„ë£Œ (2025-12-02)

### ì ìš©ëœ í•´ê²°ì±…

#### 1. ì•ˆì „ì¥ì¹˜ ì¶”ê°€ (unified-worker.js:299-304)
```javascript
// â­ ì•ˆì „ì¥ì¹˜: videoëŠ” ì ˆëŒ€ completedê°€ ë˜ë©´ ì•ˆ ë¨ (BTS-0000016)
if (type === 'video') {
  const errorMsg = `CRITICAL: video stage cannot be completed without youtube stage`;
  console.error(`âŒ [${type}] ${errorMsg}, taskId=${taskId}`);
  throw new Error(errorMsg);
}
```

**íš¨ê³¼:** video ë‹¨ê³„ê°€ completedë¡œ ì˜ëª» ì„¤ì •ë˜ëŠ” ê²ƒì„ **ì›ì²œ ì°¨ë‹¨**

#### 2. ë¡œê·¸ ê°•í™” (unified-worker.js:617-649)
```javascript
try {
  console.log(`â­ [TRIGGER] Starting: ${currentType} â†’ ${nextType} for ${taskId}`);

  // content UPDATE ë¡œê·¸
  console.log(`â­ [TRIGGER] Updating content.status to '${currentType}'`);
  const contentResult = await run(...);
  console.log(`â­ [TRIGGER] content UPDATE result:`, contentResult);

  // task_queue UPDATE ë¡œê·¸
  console.log(`â­ [TRIGGER] Updating task_queue: type='${nextType}', status='waiting'`);
  const queueResult = await run(...);
  console.log(`â­ [TRIGGER] task_queue UPDATE result:`, queueResult);

  return true;

} catch (error) {
  console.error(`â­ [TRIGGER] Error details:`, error.message);
  console.error(`â­ [TRIGGER] Stack trace:`, error.stack);
  throw error; // (BTS-0000016)
}
```

**íš¨ê³¼:** triggerNextStage ì‹¤í–‰ ê³¼ì • ìƒì„¸ ì¶”ì  ê°€ëŠ¥

### ìˆ˜ì •ëœ íŒŒì¼

- **`trend-video-frontend/src/workers/unified-worker.js`**
  - Line 299-304: video completed ì•ˆì „ì¥ì¹˜ ì¶”ê°€
  - Line 617-649: triggerNextStage ë¡œê·¸ ê°•í™”
  - Line 650-652: ì—ëŸ¬ throw ì£¼ì„ ì—…ë°ì´íŠ¸

### ì„ì‹œ ë³µêµ¬ ë°©ë²•

**Task 6cadc518ì„ youtube waitingìœ¼ë¡œ ìˆ˜ë™ ë³€ê²½:**
```sql
UPDATE task_queue
SET type = 'youtube', status = 'waiting', error = NULL
WHERE task_id = '6cadc518-f561-42bd-b60d-7b2b695e1bc3';

UPDATE content
SET status = 'video'
WHERE content_id = '6cadc518-f561-42bd-b60d-7b2b695e1bc3';
```

### ì¬ë°œ ë°©ì§€

1. **Worker ì¬ì‹œì‘ í™•ì¸**
   - ì½”ë“œ ìˆ˜ì • í›„ ë°˜ë“œì‹œ í”„ë¡œì„¸ìŠ¤ ì¬ì‹œì‘
   - PM2 ì‚¬ìš© ì‹œ `pm2 reload` ë˜ëŠ” `pm2 restart`

2. **ì•ˆì „ì¥ì¹˜ ì¶”ê°€**
   - videoëŠ” completedê°€ ë  ìˆ˜ ì—†ë‹¤ëŠ” ì²´í¬ ì¶”ê°€
   - ì¤‘ê°„ ë‹¨ê³„(script, image, video)ëŠ” completed ë¶ˆê°€

3. **ë¡œê·¸ ê°•í™”**
   - triggerNextStageì˜ ê° ë‹¨ê³„ë³„ ë¡œê·¸ ì¶”ê°€
   - DB UPDATE ê²°ê³¼ í™•ì¸

---
