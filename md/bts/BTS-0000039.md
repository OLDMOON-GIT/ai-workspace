# BTS-0000039: 상품/숏폼 YouTube 업로드 로직 미작동

**발생일:** 2025-12-03

**상태:** ✅ 해결됨

**심각도:** 🔴 **CRITICAL** - 상품 YouTube 설명 및 숏폼→롱폼 링크 누락

---

## 증상

**사용자 피드백:**
> "유튜브 업로드에서 상품, 롱폼투숏폼은 어떻게 해야되냐면 시발아 또 빼먹엇어"

### 문제 1: 상품 YouTube 설명 누락
- 상품 대본 생성 시 `story.json`에 `youtube_description` 필드가 있음
- 하지만 YouTube 업로드 시 이 설명이 사용되지 않음
- 기본 설명만 업로드됨

### 문제 2: 숏폼→롱폼 링크 누락
- 롱폼을 숏폼으로 변환한 경우
- YouTube 업로드 시 원본 롱폼 링크가 설명/고정 댓글에 추가되어야 함
- 하지만 링크가 추가되지 않음

---

## 근본 원인

**문제 파일:**
- `src/workers/unified-worker.js:701`

**원인:**
상품 체크 로직이 **한글 `category` 필드**를 사용하고 있었음:

```javascript
❌ 문제 코드 (Line 701):
if (content.category === '상품') {
  // story.json에서 youtube_description 로드
}
```

**왜 문제인가?**

1. **취약한 한글 체크**
   - 한글 텍스트는 인코딩 문제로 깨질 수 있음
   - 예: `'상품'` → `'?�품'` (garbled)
   - 깨지면 조건문이 절대 true가 되지 않음

2. **잘못된 필드 사용**
   - `category` 필드는 UI 표시용 한글 텍스트
   - 로직 체크에는 `promptFormat` 필드를 사용해야 함
   - `promptFormat`은 `'product'`, `'shortform'`, `'longform'` 같은 영문 값

3. **일관성 없음**
   - 같은 파일 Line 726에서는 숏폼을 올바르게 체크:
   ```javascript
   if (content.prompt_format === 'shortform' || content.promptFormat === 'shortform')
   ```
   - 상품만 다른 방식으로 체크하고 있었음

---

## 해결 방법

### ✅ promptFormat 필드로 체크하도록 수정

**수정한 파일:**
- `src/workers/unified-worker.js:701`

**변경 내용:**

```javascript
❌ 이전 (취약한 한글 체크):
if (content.category === '상품') {

✅ 이후 (안전한 영문 필드 체크):
if (content.promptFormat === 'product' || content.prompt_format === 'product') {
```

**이유:**
- `promptFormat`/`prompt_format` 필드는 영문 값 (`'product'`, `'shortform'`, etc.)
- 인코딩 문제 없음
- 숏폼 체크와 동일한 패턴 (일관성 유지)
- snake_case와 camelCase 모두 지원

---

## 영향 범위

**수정된 파일:**
- `src/workers/unified-worker.js:701` - 상품 체크 로직 수정

**영향 받는 기능:**
- 상품 대본 YouTube 업로드 (description, pinned comment)
- 숏폼 YouTube 업로드 (롱폼 링크 추가) - 이미 올바르게 구현되어 있었음

**기존 로직 (변경 없음):**

### 상품 (Lines 700-723):
```javascript
// story.json에서 youtube_description 로드
if (content.promptFormat === 'product' || content.prompt_format === 'product') {
  const storyPath = path.join(taskFolder, 'story.json');
  const storyData = parseJsonSafely(storyContent).data;

  if (storyData.youtube_description && storyData.youtube_description.text) {
    description = storyData.youtube_description.text;
    pinnedComment = description; // 상품은 고정 댓글도 설정
  }
}
```

### 숏폼 (Lines 725-775):
```javascript
// 롱폼 YouTube URL 추가
if (content.prompt_format === 'shortform' || content.promptFormat === 'shortform') {
  // 1. source_content_id로 롱폼 YouTube URL 찾기
  const sourceContent = await getOne(`
    SELECT youtube_url FROM content WHERE content_id = ?
  `, [content.source_content_id]);

  if (sourceContent && sourceContent.youtube_url) {
    longformUrl = sourceContent.youtube_url;
  }

  // 2. story.json에서도 확인
  if (!longformUrl) {
    // storyData.metadata.longform_youtube_url 체크
  }

  // 3. 설명과 고정 댓글에 추가
  if (longformUrl) {
    description = `🎬 전체 영상 보기: ${longformUrl}\n\n${description}`;
    pinnedComment = `🎬 전체 영상 보러가기 👉 ${longformUrl}`;
  }
}
```

---

## 테스트 방법

### 1. 상품 YouTube 업로드 테스트

1. 상품 대본 생성 (promptFormat: 'product')
2. `story.json`에 `youtube_description.text` 확인
3. YouTube 업로드 실행
4. 업로드된 영상의 설명이 `youtube_description.text`와 일치하는지 확인
5. 고정 댓글도 동일한 텍스트인지 확인

**기대 결과:**
```
✅ 삶을 그대로 담은 NFC 착즙 100% 원액입니다!
✅ 사과, 비트, 당근 항산화소 농축의 핵심...
✅ 편리한 2.1L 대용량...
이에 따른 일정액의 수수료를 제공받습니다.
```

### 2. 숏폼 YouTube 업로드 테스트

1. 롱폼 대본 생성 및 YouTube 업로드 (URL 저장됨)
2. 해당 롱폼을 숏폼으로 변환 (source_content_id 설정)
3. 숏폼 YouTube 업로드 실행
4. 업로드된 영상의 설명 첫 줄에 롱폼 링크가 있는지 확인
5. 고정 댓글에 롱폼 링크가 있는지 확인

**기대 결과:**
```
설명:
🎬 전체 영상 보기: https://youtu.be/xxxxx

[기존 설명...]

고정 댓글:
🎬 전체 영상 보러가기 👉 https://youtu.be/xxxxx
```

---

## 재발 방지

### 코딩 규칙

1. ✅ **로직 체크에는 영문 필드 사용**
   - ❌ 나쁜 예: `content.category === '상품'`
   - ✅ 좋은 예: `content.promptFormat === 'product'`

2. ✅ **한글은 UI 표시용으로만 사용**
   - 조건문, 비교 연산에서 한글 사용 금지
   - DB 저장/조회도 영문 키 사용

3. ✅ **일관된 패턴 유지**
   - 같은 종류의 체크는 동일한 패턴 사용
   - 예: 상품/숏폼/롱폼 모두 `promptFormat` 체크

4. ✅ **snake_case/camelCase 호환**
   - 필드 이름 변경 대비해 둘 다 체크
   - 예: `content.promptFormat || content.prompt_format`

---

## 구현 완료

- ✅ unified-worker.js Line 701 수정
- ✅ 상품 체크를 promptFormat으로 변경
- ✅ 숏폼 체크는 이미 올바르게 구현되어 있음
- ✅ 한글 의존성 제거

---

## 관련 이슈

- **BTS-0000024**: 원래 이 이슈에서 상품/숏폼 기능이 구현됨
  - 하지만 상품 체크 로직이 잘못되어 작동하지 않았음
  - 이번에 로직 수정으로 완전 해결

- **BTS-0000038**: 한글 narration 품질 저하
  - 프롬프트에 한글 출력 규칙 추가
  - 이 이슈도 한글 텍스트의 취약성을 보여줌
