# BTS-0000035: 대본 나레이션에 (150자) 같은 글자수 카운트 포함됨

**발생일:** 2025-12-03

**상태:** ✅ 해결됨 (재발 후 완전 수정)

**심각도:** 🟠 **MAJOR** - 나레이션 품질 저하, 시청자 혼란

**증상:**

**1차 발생 (2025-12-03):**
- 대본 생성 시 나레이션에 "(150자)", "(300~400자)" 같은 글자수 카운트가 포함됨
- 사용자 요청: "이런 건 포함되지 않게 해줘"

**재발 (2025-12-03 후반):**
> "(xx자) 또 나온다 ㅠ 상품프롬프트"
- 1차 수정 후에도 상품 프롬프트에서 계속 발생
- 프롬프트에 규칙만 추가하고 예시는 수정 안 함

**근본 원인:**

### 프롬프트에 글자수 표시가 명확히 구분 안 됨

**문제 파일:** `prompts/prompt_longform.txt:176-177`
```
- 씬 0: **3초 폭탄 씬** (독립 제작, 300~400자)
- 씬 1~7: 본 서사 (씬당 1,750자 정확히) 🆕 출력 제한 최적화
```

**문제점:**
1. AI가 프롬프트를 읽고 "(300~400자)" 같은 글자수 표시를 나레이션에 포함시킬 수 있음
2. 프롬프트에서 "글자수는 나레이션에 포함하지 말 것" 같은 명확한 지시가 없음

---

## 조사 내역

### 1. 프롬프트 파일 확인

**파일:** `prompts/prompt_longform.txt`

**글자수 언급 위치:**
- Line 176: `씬 0: **3초 폭탄 씬** (독립 제작, 300~400자)`
- Line 177: `씬 1~7: 본 서사 (씬당 1,750자 정확히)`

**다른 프롬프트 파일:**
- `prompts/prompt_shortform.txt`
- `prompts/prompt_product.txt`
- `prompts/prompt_sora2.txt`

→ 모든 프롬프트 파일 확인 필요

---

## 해결 방법

### ✅ 1차 방어: 프롬프트 수정 (AI가 생성하지 않도록)

**수정할 파일:**
- `prompts/prompt_longform.txt`
- `prompts/prompt_shortform.txt`
- `prompts/prompt_product.txt`
- `prompts/prompt_sora2.txt`

**수정 방법:**
프롬프트에 명확한 지시 추가:

```
🚨 **중요: 글자수 카운트 금지** 🚨
- 나레이션에 "(150자)", "(300자)" 같은 글자수 표시를 절대 포함하지 마세요
- 글자수는 내부 기준일 뿐, 출력 JSON의 narration 필드에는 포함 금지
- 예: "이것은 시작에 불과했습니다 (150자)" ❌
- 예: "이것은 시작에 불과했습니다" ✅
```

### ✅ 2차 방어: JSON 파서에 안전장치 추가

**수정할 파일:**
- `src/lib/json-utils.cjs` (parseJsonSafely)
- 또는 대본 생성 후처리 로직

**로직:**
```javascript
// 나레이션에서 (xx자) 패턴 제거
function cleanNarration(text) {
  if (!text) return text;
  // (150자), (300~400자), (50자) 등 제거
  return text.replace(/\s*\([0-9~]+자\)/g, '');
}
```

**적용 위치:**
- story.json 저장 전
- 각 scene의 narration 필드 처리 시

---

## 재발 방지

### 프롬프트 작성 규칙

1. ✅ 글자수 제한은 "내부 지침"으로 명시
2. ✅ "출력에는 포함 금지" 명확히 지시
3. ✅ 예시에 ❌ 잘못된 예, ✅ 올바른 예 포함

### JSON 파서 검증 규칙

1. ✅ 모든 narration 필드에서 `\([0-9~]+자\)` 패턴 제거
2. ✅ 테스트 케이스 추가:
   - "이것은 시작입니다 (150자)" → "이것은 시작입니다"
   - "갈등이 시작됩니다(50자)" → "갈등이 시작됩니다"

---

## 구현 완료

**1단계: JSON 파서 안전장치 (1차 수정)**
- ✅ cleanNarrationCharCounts 함수 생성 (`json-utils.cjs:7-33`)
- ✅ parseJsonSafely에 통합 (`json-utils.cjs:46, 54`)
- ✅ story.json 생성 시 모든 narration 필드에서 자동 제거

**2단계: 프롬프트 규칙 추가 (재발 후 완전 수정)**

### 상품 프롬프트 (`prompt_product.txt`)
- ✅ 한글 출력 규칙에 규칙 6 추가 (Line 90-96)
- ✅ 명확한 금지 지시 및 예시 추가
- ✅ narration 예시에서 (50자), (150자) 제거 (Line 253, 262, 271, 280)

### 롱폼 프롬프트 (`prompt_longform.txt`)
- ✅ 한글 출력 규칙에 규칙 6 추가 (Line 205-210)
- ✅ 명확한 금지 지시 및 예시 추가

### 숏폼 프롬프트 (`prompt_shortform.txt`)
- ✅ 한글 출력 규칙에 규칙 6 추가 (Line 227-232)
- ✅ 명확한 금지 지시 및 예시 추가

**추가된 규칙:**
```markdown
6. ✅ **글자수 카운트 절대 포함 금지 (BTS-0000035)**
   - ❌ 나쁜 예: "부드러운 빛을 밝히는 귀여운 병아리 친구 (50자)"
   - ❌ 나쁜 예: "밤마다 아기를 재우느라... (150자)"
   - ❌ 나쁜 예: "은은한 LED 조명이... (약 100자)"
   - ✅ 좋은 예: "부드러운 빛을 밝히는 귀여운 병아리 친구"
   - narration 필드에 **(50자)**, **(150자)**, **(xx자)** 같은 글자수 표시 절대 금지
   - 글자수는 가이드라인일 뿐, 실제 narration 텍스트에 포함하면 안 됨
```

**3단계: 테스트**
- ✅ 새 대본 생성 시 자동 제거 확인 (JSON 파서)
- ✅ AI가 생성하지 않도록 프롬프트 수정 (AI 단계)
