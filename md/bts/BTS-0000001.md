# BTS-0000001: locked_by 컬럼 참조 에러

**발생일:** 2025-12-02

**상태:** ✅ 해결됨

**에러 메시지:**
```
Unknown column 'locked_by' in 'where clause'
```

**증상:**
- task worker들이 작업을 처리하지 못함
- task_lock 테이블 쿼리 실패

**원인:**
- task_lock 테이블 스키마가 `locked_by`에서 `lock_task_id`로 리팩토링됨
- 코드 16개 파일에서 여전히 `locked_by` 컬럼 참조

**영향 범위:**
- `unified-worker.js`
- `queue-manager.ts`
- `startup-recovery.ts`
- `automation/cleanup/route.ts`
- `automation/retry/route.ts`
- `automation/titles/route.ts`
- `automation/stop/route.ts`
- `lib/automation.ts`
- `lib/automation-scheduler.ts`
- 기타 6개 파일

**해결 방법:**
1. 모든 `locked_by = ?` → `lock_task_id = ?` 변경
2. `WHERE locked_by IS NOT NULL` → `WHERE worker_pid IS NOT NULL` 변경
3. `SELECT locked_by` → `SELECT worker_pid` 변경
4. PowerShell 스크립트로 일괄 수정 (`fix-locked-by.ps1`)
5. 데이터베이스 마이그레이션 실행 (`migrate-locked-by.mjs`)
6. MySQL에서 `locked_by` 컬럼 제거

**수정 커밋:**
- unified-worker.js (lines 54-111)
- queue-manager.ts (lines 93-112, 194-219, 272-283)
- startup-recovery.ts (lines 36-60, 193-200)

**재발 방지:**
- 스키마 변경 시 전체 코드베이스 grep으로 참조 확인 필수
- 컬럼명 변경 체크리스트 작성

---
