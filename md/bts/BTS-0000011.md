# BTS-0000011: TTS 음성 설정이 저장되지 않는 문제

**발생일:** 2025-12-02

**상태:** ✅ 해결됨

**증상:**
1. 수정 폼에서 TTS 음성을 "선희"로 변경하고 저장
2. 저장 후 다시 수정 버튼을 누르면
3. **이전에 저장한 "선희"가 나오지 않고 다시 "순복"으로 표시됨**

**사용자 리포트:**
- "수정에 TTS음석에서 수정을 선희로 하고 저장해도 저장된게 다음에 수정버튼을 누르면 나오지 않는다"
- 현재 표시: `ko-KR-SoonBokNeural` (순복)
- promptFormat: `longform`

**원인 (조사 필요):**
1. **저장 문제**: `saveEdit` 함수가 API에 ttsVoice를 제대로 전달하지 못함
2. **API 저장 문제**: `/api/automation/titles` PATCH가 DB에 저장하지 못함
3. **로드 문제**: `getAllSchedule` 쿼리가 tts_voice를 가져오지 못함
4. **초기화 문제**: `startEdit` 함수가 기본값으로 덮어씀

**확인해야 할 부분:**
1. `saveEdit` 함수에서 payload에 ttsVoice 포함 여부 확인
2. `/api/automation/titles` PATCH 핸들러에서 ttsVoice 처리 확인
3. `content_setting` 테이블에 실제로 저장되는지 확인
4. `getAllSchedule` SQL 쿼리 결과에 ttsVoice 포함 여부 확인
5. `startEdit` 함수에서 title.ttsVoice 값 확인

**영향 범위:**
- `src/app/automation/page.tsx` (lines 1406-1433): saveEdit 함수
- `src/app/automation/page.tsx` (lines 1369-1391): startEdit 함수
- `src/app/api/automation/titles/route.ts` (lines 200-207): PATCH 핸들러
- `sql/automation.sql` (lines 180-182): getAllSchedule 쿼리
- `content_setting` 테이블: tts_voice 컬럼

**해결 작업:**

### 1. ✅ autoConvert 필드명 버그 수정 (`page.tsx:1423`)
**문제**: saveEdit 함수의 payload에서 잘못된 필드명 사용
```typescript
// Before (❌ 잘못):
autoConvert: editForm.auto_create_shortform

// After (✅ 올바름):
autoConvert: editForm.autoConvert
```
- editForm에는 `autoConvert` 필드가 있음 (line 1393)
- payload에서 `editForm.auto_create_shortform` 참조 시 undefined 전달됨
- 이 버그로 인해 autoConvert 값도 저장되지 않았음!

### 2. ✅ 디버그 로그 추가
**프론트엔드** (`page.tsx`):
- Line 1408: saveEdit 시작 시 editForm 전체 로깅 (기존)
- Line 1426: API 전송 payload 로깅 (기존)
- Line 1375-1380: startEdit 시 TTS 음성 값 로깅 (기존)
- Line 4048: TTS 음성 dropdown에 promptFormat 값 표시 추가
- Line 4054-4057: TTS 음성 변경 시 promptFormat 포함 로깅

**백엔드** (`route.ts`):
- Line 139-146: API가 받은 데이터 로깅 (ttsVoice, ttsSpeed, autoConvert 포함)
- Line 225-228: UPDATE 쿼리 실행 전 로깅 (updates, values)
- Line 234: UPDATE 완료 로깅

### 3. ✅ React key 수정 (`page.tsx:4211`)
```typescript
// Before:
key={idx}

// After:
key={`log-${title.id}-${idx}-${logTimestamp}`}
```

### 4. ✅ startEdit에서 nullish coalescing (`??`) 사용 (`page.tsx:1392-1394`)
**문제**: `||` 연산자는 falsy 값(빈 문자열 포함)을 모두 스킵하여 항상 기본값 사용
```typescript
// Before (❌ 빈 문자열도 스킵):
ttsVoice: title.ttsVoice || title.tts_voice || defaultTtsVoice
ttsSpeed: title.ttsSpeed || title.tts_speed || '+0%'
autoConvert: title.autoCreateShortform || title.autoConvert || title.auto_create_shortform || false

// After (✅ null/undefined만 스킵):
ttsVoice: title.ttsVoice ?? title.tts_voice ?? defaultTtsVoice
ttsSpeed: title.ttsSpeed ?? title.tts_speed ?? '+0%'
autoConvert: title.autoCreateShortform ?? title.autoConvert ?? title.auto_create_shortform ?? false
```
- DB에 빈 문자열('')이 저장된 경우에도 빈 문자열을 유지
- null/undefined인 경우에만 기본값 사용

### 5. ✅ Type dropdown onChange에서 TTS 음성 덮어쓰기 제거 (`page.tsx:3838-3839`)
**문제**: Type 변경 시 사용자가 선택한 TTS 음성을 기본값으로 강제 변경
```typescript
// Before (❌ TTS 음성 덮어씀):
const ttsVoice = getDefaultTtsByType(promptFormat);
setEditForm({ ...editForm, promptFormat, aiModel, ttsVoice });

// After (✅ TTS 음성 유지):
setEditForm({ ...editForm, promptFormat, aiModel });
```
- 사용자가 TTS 음성을 "선희"로 선택
- Type dropdown을 건드리면 "순복"으로 강제 변경됨
- Type 변경 시에도 사용자가 선택한 TTS 음성 유지

### 6. ✅ autoConvert 체크박스 필드명 통일 (`page.tsx:4097-4098`)
**문제**: 체크박스가 다른 필드명 사용
```typescript
// Before (❌):
checked={editForm.auto_create_shortform || false}
onChange={(e) => setEditForm({ ...editForm, auto_create_shortform: e.target.checked })}

// After (✅):
checked={editForm.autoConvert || false}
onChange={(e) => setEditForm({ ...editForm, autoConvert: e.target.checked })}
```

**근본 원인:**
1. `||` 연산자 사용으로 인해 빈 문자열('')도 falsy로 처리되어 기본값 사용
2. editForm 필드명 불일치 (auto_create_shortform ↔ autoConvert)
3. Type dropdown onChange에서 TTS 음성 강제 변경
4. TTS 음성 dropdown value에서도 `||` 사용

**재발 방지:**
- editForm 필드명은 항상 camelCase로 통일
- DB에서 로드한 값이 falsy일 때만 기본값 사용하려면 `??` (nullish coalescing) 사용
- 폼 컨트롤(input, select, checkbox)은 항상 editForm의 필드명과 일치시킬 것

---
