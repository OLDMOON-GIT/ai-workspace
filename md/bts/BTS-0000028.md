# BTS-0000028: ëª¨ë“  ë‹¨ê³„ì—ì„œ ë¡œê·¸ íŒŒì¼ì´ ì €ì¥ë˜ì§€ ì•ŠìŒ

**ë°œìƒì¼:** 2025-12-03

**ìƒíƒœ:** âœ… **í•´ê²°ë¨** (ì™„ì „ ìˆ˜ì • ì™„ë£Œ)

**ì‹¬ê°ë„:** ğŸŸ  **MAJOR** - ë””ë²„ê¹… ë¶ˆê°€ëŠ¥, ë¡œê·¸ ì¶”ì  ì–´ë ¤ì›€

---

## ì¦ìƒ

**ë¡œê·¸ íŒŒì¼ì´ ìƒì„±ë˜ì§€ ì•ŠìŒ:**
- âŒ Script: `tasks/{taskId}/script.log` íŒŒì¼ ì—†ìŒ
- âŒ Image: ì‹œì‘/ì™„ë£Œ ë¡œê·¸ ëˆ„ë½
- âŒ Video: `tasks/{taskId}/video.log` íŒŒì¼ ì—†ìŒ
- âŒ ì—ëŸ¬ ë°œìƒ ì‹œ catch ë¸”ë¡ì—ì„œ ë¡œê·¸ íŒŒì¼ ì €ì¥ ì•ˆ ë¨

**ì‚¬ìš©ì í”¼ë“œë°± (2025-12-03 ì¬ë°œ):**
> "ì•„ì§ë„ ì´ë¯¸ì§€ë¡œê·¸ëŠ” ì–´íŒ¬ë“œê°€ ì•ˆë˜ê³  ìˆê³  ì‹œë°œ"

**ì‹¤ì œ ë¬¸ì œ:**
- ë¡œê·¸ê°€ ì½˜ì†”ê³¼ DBì—ë§Œ ì €ì¥ë˜ê³  íŒŒì¼ë¡œ ì €ì¥ë˜ì§€ ì•ŠìŒ
- íŒŒì¼ ë¡œê·¸ê°€ ì—†ì–´ì„œ ì‘ì—… ì™„ë£Œ í›„ ë””ë²„ê¹… ë¶ˆê°€ëŠ¥
- íŠ¹íˆ ì´ë¯¸ì§€ ìƒì„±ì˜ ì‹œì‘/ì™„ë£Œ ë¡œê·¸ê°€ ì—†ì–´ì„œ ì§„í–‰ ìƒí™© íŒŒì•… ì–´ë ¤ì›€

---

## ê·¼ë³¸ ì›ì¸

### 1ì°¨ ìˆ˜ì • (ì´ì „) - ë¶ˆì™„ì „
- Script ë‹¨ê³„: API ê²°ê³¼ ë¡œê·¸ì—ë§Œ ì¶”ê°€
- Video ë‹¨ê³„: ì™„ë£Œ ë¡œê·¸ì—ë§Œ ì¶”ê°€
- Image ë‹¨ê³„: Python stdout/stderrë§Œ ì¶”ê°€

### ëˆ„ë½ëœ ë¶€ë¶„ (ì¬ë°œ ì›ì¸)
1. **Image ì‹œì‘ ë¡œê·¸ ëˆ„ë½** (Line 520)
   - ì´ë¯¸ì§€ ìƒì„± ì‹œì‘ ì‹œ ë¡œê·¸ íŒŒì¼ì— ê¸°ë¡ ì•ˆ ë¨
   - ì–´ë–¤ ëª¨ë“œë¡œ ì‹œì‘í–ˆëŠ”ì§€, ë¹„ìœ¨ì€ ë¬´ì—‡ì¸ì§€ ê¸°ë¡ ì—†ìŒ

2. **Image ì™„ë£Œ ë¡œê·¸ ëˆ„ë½** (Line 543)
   - Python í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ ì‹œ ì„±ê³µ ë¡œê·¸ ì—†ìŒ
   - ë‹¨ìˆœíˆ resolve()ë§Œ í˜¸ì¶œ

3. **ì—ëŸ¬ ë¡œê·¸ ëˆ„ë½** (Line 346-358)
   - Main catch ë¸”ë¡ì—ì„œ `appendToLogFile` í˜¸ì¶œ ì—†ìŒ
   - ì—ëŸ¬ ë°œìƒ ì‹œ íŒŒì¼ì— ê¸°ë¡ë˜ì§€ ì•ŠìŒ

---

## í•´ê²° ë°©ë²•

### âœ… 1. Image ì‹œì‘ ë¡œê·¸ ì¶”ê°€ (Line 520-523)

```javascript
const startMsg = `ğŸ¨ ì´ë¯¸ì§€ ìƒì„± ì‹œì‘ (ëª¨ë“œ: ${imageMode}, ë¹„ìœ¨: ${aspectRatio})`;
console.log(`${emoji} [${type}] ${startMsg}`);
await this.appendLog(taskId, type, startMsg);
appendToLogFile(taskId, 'image', startMsg); // BTS-0000028: ì‹œì‘ ë¡œê·¸ íŒŒì¼ ì €ì¥
```

### âœ… 2. Image ì™„ë£Œ ë¡œê·¸ ì¶”ê°€ (Line 542-552)

```javascript
pythonProcess.on('close', async (code) => {
  if (code === 0) {
    const successMsg = 'âœ… ì´ë¯¸ì§€ ìƒì„± ì™„ë£Œ';
    console.log(`${emoji} [${type}] ${successMsg}`);
    await this.appendLog(taskId, type, successMsg).catch(() => {});
    appendToLogFile(taskId, 'image', successMsg); // BTS-0000028: ì„±ê³µ ë¡œê·¸ íŒŒì¼ ì €ì¥
    resolve();
  } else {
    reject(new Error(`Python script exited with code ${code}\n${errorOutput}`));
  }
});
```

### âœ… 3. ì—ëŸ¬ ë¡œê·¸ ì¶”ê°€ (Line 346-358)

```javascript
} catch (error) {
  console.error(`${emoji} [${type}] âŒ Failed: ${taskId}`, error.message);

  // ì—ëŸ¬ ë¡œê·¸ íŒŒì¼ì— ê¸°ë¡ (BTS-0000028)
  const errorMsg = `âŒ ì—ëŸ¬: ${error.message}`;
  await this.appendLog(taskId, type, errorMsg);
  appendToLogFile(taskId, type, errorMsg); // BTS-0000028: ì—ëŸ¬ ë¡œê·¸ íŒŒì¼ ì €ì¥

  if (error.stack) {
    const stackMsg = `ìŠ¤íƒ íŠ¸ë ˆì´ìŠ¤:\n${error.stack}`;
    await this.appendLog(taskId, type, stackMsg);
    appendToLogFile(taskId, type, stackMsg); // BTS-0000028: ìŠ¤íƒ íŠ¸ë ˆì´ìŠ¤ íŒŒì¼ ì €ì¥
  }

  await this.updateTask(taskId, type, {
    state: 'failed',
    error: error.message
  });
}
```

---

## ìˆ˜ì • ì™„ë£Œ í˜„í™©

### Script ë‹¨ê³„
- âœ… API ê²°ê³¼ ë¡œê·¸ (Line 473)
- âœ… ì—ëŸ¬ ë¡œê·¸ (catch ë¸”ë¡)

### Image ë‹¨ê³„
- âœ… ì‹œì‘ ë¡œê·¸ (Line 523) - **ì‹ ê·œ ì¶”ê°€**
- âœ… Python stdout (Line 535)
- âœ… Python stderr (Line 539)
- âœ… ì™„ë£Œ ë¡œê·¸ (Line 547) - **ì‹ ê·œ ì¶”ê°€**
- âœ… ì—ëŸ¬ ë¡œê·¸ (catch ë¸”ë¡) - **ì‹ ê·œ ì¶”ê°€**

### Video ë‹¨ê³„
- âœ… ì™„ë£Œ ë¡œê·¸ (Line 591)
- âœ… ì—ëŸ¬ ë¡œê·¸ (catch ë¸”ë¡)

### YouTube ë‹¨ê³„
- âœ… ëª¨ë“  ë¡œê·¸ (ì´ë¯¸ ì™„ë£Œë˜ì–´ ìˆì—ˆìŒ)

---

## ì¬ë°œ ë°©ì§€

### ë¡œê·¸ ì‘ì„± ê·œì¹™

1. âœ… **ì‹œì‘ ë¡œê·¸ í•„ìˆ˜**
   - ëª¨ë“  ë‹¨ê³„ ì‹œì‘ ì‹œ ë¡œê·¸ íŒŒì¼ì— ê¸°ë¡
   - ì–´ë–¤ ì„¤ì •ìœ¼ë¡œ ì‹œì‘í–ˆëŠ”ì§€ ëª…í™•íˆ ê¸°ë¡

2. âœ… **ì™„ë£Œ ë¡œê·¸ í•„ìˆ˜**
   - ì‘ì—… ì™„ë£Œ ì‹œ ì„±ê³µ ë¡œê·¸ íŒŒì¼ì— ê¸°ë¡
   - ë‹¨ìˆœíˆ resolve()ë§Œ í•˜ì§€ ë§ ê²ƒ

3. âœ… **ì—ëŸ¬ ë¡œê·¸ í•„ìˆ˜**
   - catch ë¸”ë¡ì—ì„œ ë°˜ë“œì‹œ `appendToLogFile` í˜¸ì¶œ
   - ì—ëŸ¬ ë©”ì‹œì§€ì™€ ìŠ¤íƒ íŠ¸ë ˆì´ìŠ¤ ëª¨ë‘ ê¸°ë¡

4. âœ… **ì¤‘ê°„ ë¡œê·¸ ê¶Œì¥**
   - stdout/stderr ì‹¤ì‹œê°„ ê¸°ë¡
   - ì§„í–‰ ìƒí™© íŒŒì•… ê°€ëŠ¥í•˜ë„ë¡

### ì²´í¬ë¦¬ìŠ¤íŠ¸ (ìƒˆ ë‹¨ê³„ ì¶”ê°€ ì‹œ)

```javascript
// 1. ì‹œì‘ ë¡œê·¸
await this.appendLog(taskId, type, 'ì‹œì‘ ë©”ì‹œì§€');
appendToLogFile(taskId, type, 'ì‹œì‘ ë©”ì‹œì§€');

// 2. ì¤‘ê°„ ë¡œê·¸ (ì‹¤ì‹œê°„)
process.stdout.on('data', (data) => {
  this.appendLog(taskId, type, data.toString()).catch(() => {});
  appendToLogFile(taskId, type, data.toString());
});

// 3. ì™„ë£Œ ë¡œê·¸
await this.appendLog(taskId, type, 'ì™„ë£Œ ë©”ì‹œì§€');
appendToLogFile(taskId, type, 'ì™„ë£Œ ë©”ì‹œì§€');

// 4. ì—ëŸ¬ ë¡œê·¸ (catch ë¸”ë¡)
catch (error) {
  await this.appendLog(taskId, type, `âŒ ì—ëŸ¬: ${error.message}`);
  appendToLogFile(taskId, type, `âŒ ì—ëŸ¬: ${error.message}`);
}
```

---

## ì˜í–¥ ë²”ìœ„

**ìˆ˜ì •ëœ íŒŒì¼:**
- `src/workers/unified-worker.js:520-523` - Image ì‹œì‘ ë¡œê·¸
- `src/workers/unified-worker.js:542-552` - Image ì™„ë£Œ ë¡œê·¸
- `src/workers/unified-worker.js:346-358` - ì—ëŸ¬ ë¡œê·¸

**ì˜í–¥ ë°›ëŠ” ê¸°ëŠ¥:**
- ëª¨ë“  Task ë‹¨ê³„ (script, image, video, youtube)
- ë¡œê·¸ íŒŒì¼ ìƒì„± (`tasks/{taskId}/{type}.log`)

---

## í…ŒìŠ¤íŠ¸ ë°©ë²•

1. ì„œë²„ ì¬ì‹œì‘ (`az.bat`)
2. ì‘ì—… ì‹¤í–‰ (script â†’ image â†’ video â†’ youtube)
3. ê° ë‹¨ê³„ ì™„ë£Œ í›„ ë¡œê·¸ íŒŒì¼ í™•ì¸:
   ```
   tasks/{taskId}/script.log   âœ…
   tasks/{taskId}/image.log    âœ…
   tasks/{taskId}/video.log    âœ…
   tasks/{taskId}/youtube.log  âœ…
   ```
4. ì˜ë„ì ìœ¼ë¡œ ì—ëŸ¬ ë°œìƒì‹œì¼œì„œ ì—ëŸ¬ ë¡œê·¸ í™•ì¸

---

## êµ¬í˜„ ì™„ë£Œ

- âœ… Image ì‹œì‘ ë¡œê·¸ ì¶”ê°€
- âœ… Image ì™„ë£Œ ë¡œê·¸ ì¶”ê°€
- âœ… Main catch ë¸”ë¡ ì—ëŸ¬ ë¡œê·¸ ì¶”ê°€
- âœ… BTS ë¬¸ì„œ ì—…ë°ì´íŠ¸

---
