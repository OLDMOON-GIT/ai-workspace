# BTS-0000010: 스펙 오해로 인한 잘못된 스키마 수정 (최대 버그!)

**발생일:** 2025-12-02

**상태:** ✅ 해결됨 (롤백 완료)

**심각도:** 🔴 **CRITICAL** - 스펙을 완전히 반대로 이해하여 시스템 전체를 잘못 수정

**증상:**
1. task_queue PRIMARY KEY를 `(task_id, type)` 복합키로 변경
2. unified-worker.js를 INSERT 방식으로 수정
3. BTS-0000008, BTS-0000009에 잘못된 스펙 기록
4. 같은 task_id에 여러 type의 큐가 생성되어 데이터 일관성 깨짐

**근본 원인:**
**원래 설계를 완전히 오해함!**

### 잘못 이해한 내용:
```
❌ 한 task_id에 4개의 독립된 task_queue 레코드가 필요하다
   → script, image, video, youtube 각각 INSERT
   → PRIMARY KEY (task_id, type)
```

### 올바른 스펙:
```
✅ 한 task_id에 1개의 task_queue 레코드만 존재
   → 단계가 진행되면 type만 UPDATE
   → PRIMARY KEY (task_id)
```

**올바른 워크플로우:**
```javascript
// ✅ 올바른 방식 (UPDATE):
UPDATE task_queue
SET type = 'image', status = 'waiting'
WHERE task_id = ?

// task_queue에는 항상 1개 레코드만!
// 이력은 task_time_log에 기록됨 (여러 레코드 가능)
```

**잘못된 수정 내역:**
1. **schema-mysql.sql** (line 147-157):
   - `PRIMARY KEY (task_id)` → `PRIMARY KEY (task_id, type)` ❌

2. **unified-worker.js** (line 600-634):
   - UPDATE 방식 → INSERT 방식 ❌

3. **BTS-0000009 등록:**
   - "PRIMARY KEY 설계 오류"라며 복합키로 변경하는 내용 기록 ❌

**피해 범위:**
- task `77fb7660-56a7-47d9-bd46-cd35b4180b64`에 script, image 두 개의 큐 생성됨
- 데이터 일관성 깨짐
- 잘못된 스펙이 BTS 문서에 기록됨

**롤백 내역:**
1. **PRIMARY KEY 복원:**
```sql
ALTER TABLE task_queue DROP PRIMARY KEY;
ALTER TABLE task_queue ADD PRIMARY KEY (task_id);
```

2. **unified-worker.js 복원** (line 600-621):
```javascript
// ✅ 올바른 방식 (현재 type을 'completed'로 하지 않음!):
// 1. content.status는 현재 단계만 기록 (script/video), image는 유지
if (currentType === 'script' || currentType === 'video') {
  await run(`
    UPDATE content
    SET status = ?
    WHERE content_id = ?
  `, [currentType, taskId]);
}

// 2. task_queue: type → 다음 단계, status → 'waiting'으로 UPDATE
await run(`
  UPDATE task_queue
  SET type = ?, status = 'waiting'
  WHERE task_id = ?
`, [nextType, taskId]);

// ⚠️ 현재 단계를 'completed'로 하지 않음!
// task_queue는 항상 1개 레코드 (현재 상태만)
// 이력은 task_time_log에 기록됨
```

3. **schema-mysql.sql 복원** (line 147):
```sql
task_id CHAR(36) PRIMARY KEY,  -- 복합키 아님!
```

4. **BTS-0000009 삭제** (잘못된 버그 보고서)

5. **BTS-0000008 정리:** content.status 단계 업데이트 누락 건만 남김

6. **중복 데이터 정리:**
   - task `77fb7660`의 script 레코드 삭제, image만 유지

**재발 방지:**
- ⚠️ **스펙을 100번 확인해도 잘못 이해할 수 있음!**
- **사용자가 "100번 얘기했다"고 하면 즉시 멈추고 다시 확인**
- 스키마 변경 시 기존 코드의 패턴을 먼저 파악
- UPDATE vs INSERT 패턴을 코드에서 확인
- 테이블 이름과 PRIMARY KEY 설계 의도 파악
- **task_queue (현재 상태 1개)** vs **task_time_log (이력 여러 개)** 구분

---
