# BTS-0000026: unified-worker YouTube ë½ì— race condition ì¡´ì¬

**ë°œìƒì¼:** 2025-12-03

**ìƒíƒœ:** âœ… **í•´ê²°ë¨**

**ì‹¬ê°ë„:** ğŸ”´ **CRITICAL** - ì—¬ì „íˆ ì¤‘ë³µ ì—…ë¡œë“œ ë°œìƒ

**ì¦ìƒ:**
BTS-0000025ì—ì„œ runningYoutubeUploads Mapì„ ì¶”ê°€í–ˆì§€ë§Œ, ì—¬ì „íˆ 2ë²ˆ ì—…ë¡œë“œë¨

**ê·¼ë³¸ ì›ì¸:**
Memory ë½ ì²´í¬ì™€ ì„¤ì • ì‚¬ì´ì— race condition ì¡´ì¬

**ì‹œë‚˜ë¦¬ì˜¤:**
1. í˜¸ì¶œA: has(taskId) â†’ false
2. í˜¸ì¶œB: has(taskId) â†’ false (Aê°€ ì•„ì§ setí•˜ì§€ ì•ŠìŒ)
3. í˜¸ì¶œA: set(taskId)
4. í˜¸ì¶œB: set(taskId) (ë®ì–´ì”€)
5. ë‘˜ ë‹¤ ì‹¤í–‰!

**ìˆ˜ì • ë‚´ì—­:**
`src/workers/unified-worker.js:577-611` - DB ë½ìœ¼ë¡œ êµì²´

```javascript
// âœ… DB atomic updateë¡œ ë½ íšë“
const lockResult = await run(`
  UPDATE task_queue
  SET status = 'processing'
  WHERE task_id = ? AND type = 'youtube' AND status = 'waiting'
`, [taskId]);

if (lockResult.affectedRows === 0) {
  throw new Error('ì´ë¯¸ ì²˜ë¦¬ ì¤‘ì´ê±°ë‚˜ ì™„ë£Œëœ ì‘ì—…ì…ë‹ˆë‹¤');
}

// Memory ë½ë„ ë³´ì¡°ë¡œ ìœ ì§€
this.runningYoutubeUploads.set(taskId, Date.now());
```

**DB ë½ì˜ ì¥ì :**
- **Atomic**: WHERE ì¡°ê±´ì— status = 'waiting' í¬í•¨ìœ¼ë¡œ í•œ ë²ˆë§Œ ì„±ê³µ
- **Process ê°„ ê³µìœ **: ì—¬ëŸ¬ ì›Œì»¤ í”„ë¡œì„¸ìŠ¤ê°€ ì‹¤í–‰ë˜ì–´ë„ ì•ˆì „
- **ì˜êµ¬ì **: í”„ë¡œì„¸ìŠ¤ ì¬ì‹œì‘ í›„ì—ë„ ìœ íš¨

---
