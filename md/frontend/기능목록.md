# íŠ¸ë Œë“œ ë¹„ë””ì˜¤ ìë™í™” ê¸°ëŠ¥ ëª©ë¡

## ì‹œìŠ¤í…œ í•µì‹¬ ìŠ¤í™ - ë™ì‹œ ì‹¤í–‰ ì œí•œ

### âš ï¸ ì¤‘ìš”: ê° ì‘ì—… íƒ€ì…ë³„ ë™ì‹œ ì‹¤í–‰ ì œí•œ
**ê° ì‘ì—… íƒ€ì…ì€ ë™ì‹œì— 1ê°œì”©ë§Œ ì‹¤í–‰ë˜ë„ë¡ ì œí•œë¨:**

1. **ëŒ€ë³¸ ìƒì„± (script)** - ë™ì‹œ ì‹¤í–‰ 1ê°œ
2. **ì´ë¯¸ì§€ í¬ë¡¤ë§ (image)** - ë™ì‹œ ì‹¤í–‰ 1ê°œ
3. **ì˜ìƒ ì œì‘ (video)** - ë™ì‹œ ì‹¤í–‰ 1ê°œ
4. **ìœ íŠœë¸Œ ì—…ë¡œë“œ (youtube)** - ë™ì‹œ ì‹¤í–‰ 1ê°œ

### êµ¬í˜„ ë°©ì‹:
- **í ë§¤ë‹ˆì €** (`src/lib/queue-manager.ts`)ì˜ `tasks_locks` í…Œì´ë¸”ë¡œ ê´€ë¦¬
- ê° íƒ€ì…ë³„ë¡œ ë½(Lock) ë©”ì»¤ë‹ˆì¦˜ ì ìš©
- í•˜ë‚˜ì˜ ì‘ì—…ì´ processing ì¤‘ì´ë©´ ë‹¤ë¥¸ ì‘ì—…ì€ waiting ìƒíƒœë¡œ ëŒ€ê¸°
- í ë°ì´í„°ë² ì´ìŠ¤: `data/queue.sqlite`

### ì´ìœ :
- **ë¦¬ì†ŒìŠ¤ ê´€ë¦¬**: PC ê³¼ë¶€í•˜ ë°©ì§€
- **API ì œí•œ**: AI ì„œë¹„ìŠ¤ë“¤ì˜ ë™ì‹œ ì ‘ì† ì œí•œ íšŒí”¼
- **Chrome í¬íŠ¸**: ë””ë²„ê¹… í¬íŠ¸ 9222 ë‹¨ì¼ ì„¸ì…˜ ì œí•œ
- **ì•ˆì •ì„±**: ë™ì‹œ ì‹¤í–‰ìœ¼ë¡œ ì¸í•œ ì¶©ëŒ ë°©ì§€
- **ì„±ê³µë¥ **: ìˆœì°¨ ì²˜ë¦¬ë¡œ ê° ì‘ì—…ì˜ ì„±ê³µë¥  í–¥ìƒ

### ì‘ë™ íë¦„:
```
[íì— ëŒ€ê¸° ì¤‘ì¸ ì‘ì—…ë“¤ (waiting)]
    â†“
[ì›Œì»¤ê°€ ë½ íšë“ í›„ 1ê°œì”© ê°€ì ¸ì˜´ (processing)]
    â†“
[ì²˜ë¦¬ ì™„ë£Œ í›„ ë½ í•´ì œ (completed)]
    â†“
[ë‹¤ìŒ ì‘ì—… ì²˜ë¦¬]
```

## ìƒí’ˆ ìë™í™” ê¸°ëŠ¥

### í…ŒìŠ¤íŠ¸ ê¸°ëŠ¥ì—ì„œì˜ ìƒí’ˆ ìë™í™”
**êµ¬í˜„ ìœ„ì¹˜**: `src/app/api/automation/test-generate-stream/route.ts`

**ë™ì‘ íë¦„**:

#### Step 1: ë² ìŠ¤íŠ¸ì…€ëŸ¬ì—ì„œ ìƒí’ˆ ì¡°íšŒ
1. **ì¿ íŒ¡ ë² ìŠ¤íŠ¸ì…€ëŸ¬ API í˜¸ì¶œ**
   - `/v2/providers/affiliate_open_api/apis/openapi/v1/products/bestcategories/1001`
   - HMAC-SHA256 ì„œëª…ìœ¼ë¡œ ì¸ì¦
   - ë² ìŠ¤íŠ¸ì…€ëŸ¬ ìˆœìœ„ ìƒí’ˆ ìë™ ì„ íƒ

#### Step 2: ë”¥ë§í¬ ìƒì„±
1. **ë”¥ë§í¬ API í˜¸ì¶œ**
   - ë² ìŠ¤íŠ¸ì…€ëŸ¬ ìƒí’ˆ URLì„ ë”¥ë§í¬ë¡œ ë³€í™˜
   - `/v2/providers/affiliate_open_api/apis/openapi/v1/deeplink` í˜¸ì¶œ
   - `https://link.coupang.com/a/xxxxx` í˜•íƒœë¡œ ë³€í™˜
   - ì‹¤íŒ¨ ì‹œ ì—ëŸ¬ ë°œìƒ (ì›ë³¸ URL ì‚¬ìš© ì•ˆ í•¨)

2. **DB ì €ì¥ ë°©ì‹**
   - `video_titles.product_url` = ìƒì„±ëœ ë”¥ë§í¬ (short URL)
   - `video_titles.product_data` JSONì— ì €ì¥:
     - `deepLink`: ìƒì„±ëœ ë‹¨ì¶• ë§í¬
     - `productUrl`: ì›ë³¸ Coupang URL (ì°¸ê³ ìš©)
   - ì˜ˆì‹œ:
     ```json
     {
       "deepLink": "https://link.coupang.com/a/c59d9h",
       "productUrl": "https://www.coupang.com/vp/products/...",
       "productName": "ìƒí’ˆëª…",
       "productPrice": 7500
     }
     ```

3. **ìˆ˜ì • í¼ì—ì„œì˜ ì²˜ë¦¬**
   - `startEdit()` í•¨ìˆ˜ê°€ product_dataì˜ `deepLink` ìš°ì„  ì¶”ì¶œ
   - product_dataì— deepLinkê°€ ìˆìœ¼ë©´ ê·¸ê²ƒì„ ì‚¬ìš©
   - ì—†ìœ¼ë©´ product_dataì˜ productUrl ì‚¬ìš©
   - ê·¸ê²ƒë„ ì—†ìœ¼ë©´ DBì˜ product_url ì»¬ëŸ¼ ì‚¬ìš©

#### Step 3: ë‚´ ëª©ë¡(ë‚´ëª©ë¡)ì— ì¶”ê°€
1. **ì¤‘ë³µ ìƒí’ˆ ì²´í¬** âœ… (êµ¬í˜„ ì™„ë£Œ)
   - ì´ë¯¸ ë‚´ ëª©ë¡ì— ìˆëŠ” ìƒí’ˆì¸ì§€ ë¨¼ì € í™•ì¸
   - `deep_link`ë¡œ ì¤‘ë³µ ì²´í¬ (ê¸°ì¡´)
   - â­ **`title`(ìƒí’ˆëª…)ìœ¼ë¡œ ì¤‘ë³µ ì²´í¬** âœ… (2025-11-25 ì¶”ê°€)
     - ê°™ì€ ì œëª©ì˜ ìƒí’ˆì€ ë“±ë¡ ë¶ˆê°€
     - ë‹¤ë¥¸ ë”¥ë§í¬ë¼ë„ ì œëª©ì´ ê°™ìœ¼ë©´ ì¤‘ë³µìœ¼ë¡œ ì²˜ë¦¬
   - ì¤‘ë³µì´ë©´ ìŠ¤í‚µ, ì—†ìœ¼ë©´ ì¶”ê°€
   - ê°™ì€ ìƒí’ˆì„ ì—¬ëŸ¬ ë²ˆ í…ŒìŠ¤íŠ¸í•´ë„ ë‚´ ëª©ë¡ì—ëŠ” í•œ ë²ˆë§Œ ì €ì¥

2. **ìƒí’ˆ ì €ì¥ ë¡œì§** âœ… (êµ¬í˜„ ì™„ë£Œ)
   - `coupang_products` í…Œì´ë¸”ì— ìƒí’ˆ INSERT (test-generate-streamì—ì„œ ìë™ ì‹¤í–‰)
   - ì €ì¥ í•­ëª©:
     - `id` (ìë™ ìƒì„± ID)
     - `user_id` (ì‚¬ìš©ì ID)
     - `product_url` (ì¿ íŒ¡ ìƒí’ˆ URL)
     - `deep_link` (ìƒì„±ëœ ë”¥ë§í¬)
     - `title` (ìƒí’ˆëª…)
     - `category` (ì¹´í…Œê³ ë¦¬)
     - `image_url` (ìƒí’ˆ ì´ë¯¸ì§€)
     - `original_price`, `discount_price` (ê°€ê²©)
     - `status` ('active')
   - ìŠ¤ì¼€ì¤„ëŸ¬ê°€ ìë™ìœ¼ë¡œ ê°ì§€

#### Step 4: ìŠ¤ì¼€ì¤„ëŸ¬ ìë™í™” - ì˜ˆì•½í ìë™ ë“±ë¡
1. **ìŠ¤ì¼€ì¤„ëŸ¬ê°€ ì‹ ê·œ ìƒí’ˆ ê°ì§€** âœ… (êµ¬í˜„ ì™„ë£Œ)
   - `checkAndRegisterCoupangProducts()` í•¨ìˆ˜ê°€ coupang_products í…Œì´ë¸” ëª¨ë‹ˆí„°ë§
   - 3ì´ˆ ê°„ê²©ìœ¼ë¡œ ì‹ ê·œ ìƒí’ˆ ê°ì§€
   - êµ¬í˜„ ìœ„ì¹˜: `src/lib/automation-scheduler.ts` Line 1720

2. **ìë™ ìŠ¤ì¼€ì¤„ ìƒì„±** âœ… (êµ¬í˜„ ì™„ë£Œ)
   - `video_titles` í…Œì´ë¸”ì— íƒ€ì´í‹€ ìƒì„±
   - ìƒí’ˆ ì •ë³´ ì €ì¥ (product_data JSON)
   - `task_schedules` í…Œì´ë¸”ì— ìŠ¤ì¼€ì¤„ ìë™ ë“±ë¡
   - ì‚¬ìš©ìì˜ í™œì„± ì±„ë„ë¡œ ìë™ ë°°ì •
   - YouTube í”„ë¼ì´ë²„ì‹œ: ê¸°ë³¸ê°’ìœ¼ë¡œ ì„¤ì •

3. **ì˜ˆì•½í ìë™ ì‹¤í–‰** âœ… (ê¸°ì¡´ êµ¬í˜„)
   - ìŠ¤ì¼€ì¤„ëœ ì‹œê°„ì— ìë™ìœ¼ë¡œ ì²˜ë¦¬
   - ëŒ€ë³¸ ìƒì„± â†’ ì˜ìƒ ìƒì„± â†’ YouTube ì—…ë¡œë“œ
   - ì „ì²´ í”„ë¡œì„¸ìŠ¤ ìë™í™”

**ê´€ë ¨ íŒŒì¼**:
- `src/app/api/automation/test-generate-stream/route.ts` - í…ŒìŠ¤íŠ¸ ê¸°ëŠ¥ ë° ë² ìŠ¤íŠ¸ì…€ëŸ¬ ì¡°íšŒ
- `src/lib/coupang-deeplink.ts` - ë”¥ë§í¬ ìƒì„± ìœ í‹¸ë¦¬í‹°
- `src/lib/automation-scheduler.ts` - ìŠ¤ì¼€ì¤„ëŸ¬ (ì‹ ê·œ ìƒí’ˆ ê°ì§€ ë° ìë™ ë“±ë¡)
- `src/app/api/coupang/products/route.ts` - ë² ìŠ¤íŠ¸ì…€ëŸ¬ ì¡°íšŒ API

**íŠ¹ì§•**:
- âœ… ë² ìŠ¤íŠ¸ì…€ëŸ¬ì—ì„œ ìƒí’ˆ ìë™ ì¡°íšŒ
- âœ… ë”¥ë§í¬ ìë™ ìƒì„±
- âœ… ë‚´ ëª©ë¡ì— ìë™ ì¶”ê°€
- âœ… ìŠ¤ì¼€ì¤„ëŸ¬ê°€ ìë™ìœ¼ë¡œ ê°ì§€
- âœ… ì˜ˆì•½íì— ìë™ ë“±ë¡
- âœ… ì˜ˆì•½ëœ ì‹œê°„ì— ì˜ìƒ ìƒì„± ë° ì—…ë¡œë“œ

**ìƒíƒœ**: âœ… ì™„ì „ êµ¬í˜„ (Step 1 ~ 4 ëª¨ë‘ ì™„ë£Œ)

---

## ìë™í™” ìƒí’ˆì¹´í…Œê³ ë¦¬ (Product Category Automation)

**ê¸°ëŠ¥ ì„¤ëª…**: ì¿ íŒ¡ ë² ìŠ¤íŠ¸ì…€ëŸ¬ì—ì„œ ìƒˆë¡œìš´ ìƒí’ˆì„ ê°€ì ¸ì™€ ë‚´ëª©ë¡ì— ë“±ë¡í•˜ê³ , ì¹´í…Œê³ ë¦¬ë³„ë¡œ ì˜ˆì•½íë¥¼ ìë™ ë“±ë¡

**ë™ì‘ íë¦„**:

### Step 1: ë² ìŠ¤íŠ¸ì…€ëŸ¬ì—ì„œ ì‹ ê·œ ìƒí’ˆ ì¡°íšŒ
1. ì¿ íŒ¡ ë² ìŠ¤íŠ¸ì…€ëŸ¬ API í˜¸ì¶œ
   - `/v2/providers/affiliate_open_api/apis/openapi/v1/products/bestcategories/[CATEGORY_ID]`
   - ê° ì¹´í…Œê³ ë¦¬ë³„ ë² ìŠ¤íŠ¸ì…€ëŸ¬ ìƒí’ˆ ëª©ë¡ ì¡°íšŒ

2. **ë‚´ëª©ë¡ ì¤‘ë³µ ì²´í¬**
   - `coupang_products` í…Œì´ë¸”ì—ì„œ ì´ë¯¸ ë“±ë¡ëœ ìƒí’ˆ ì¡°íšŒ
   - ë² ìŠ¤íŠ¸ì…€ëŸ¬ ìƒí’ˆê³¼ ë¹„êµí•˜ì—¬ **ë¯¸ë“±ë¡ ì‹ ê·œ ìƒí’ˆë§Œ í•„í„°ë§**

3. **ì‹ ê·œ ìƒí’ˆ ì„ íƒ**
   - ë¯¸ë“±ë¡ ìƒí’ˆ ì¤‘ ìˆœìœ„ê°€ ë†’ì€ ìƒí’ˆë¶€í„° ì„ íƒ (ìƒìœ„ 5ê°œ~10ê°œ)

### Step 2: ë”¥ë§í¬ ìƒì„± ë° ë‚´ëª©ë¡ ë“±ë¡
1. **ë”¥ë§í¬ ìƒì„±**
   - ë² ìŠ¤íŠ¸ì…€ëŸ¬ APIì˜ ê¸´ affiliate URL â†’ ì§§ì€ ë”¥ë§í¬ ë³€í™˜
   - `generateDeeplink()` í•¨ìˆ˜ë¡œ ë³€í™˜
   - `https://link.coupang.com/a/xxxxx` í˜•íƒœ

2. **ë‚´ëª©ë¡ì— ìƒí’ˆ ë“±ë¡**
   - `coupang_products` í…Œì´ë¸”ì— INSERT
   - ì €ì¥ í•­ëª©:
     - `product_id` (ì¿ íŒ¡ ìƒí’ˆ ID)
     - `product_name` (ìƒí’ˆëª…)
     - `deep_link` (ìƒì„±ëœ ë”¥ë§í¬)
     - `category_id` (ì¹´í…Œê³ ë¦¬ ID)
     - `image_url` (ìƒí’ˆ ì´ë¯¸ì§€)
     - `original_price`, `discount_price` (ê°€ê²©)
     - `status` ('active')

### Step 3: ì¹´í…Œê³ ë¦¬ë³„ ìë™ ì˜ˆì•½í ë“±ë¡
1. **ìƒí’ˆ ì •ë³´ ì¤€ë¹„**
   - ë“±ë¡ëœ ìƒí’ˆì˜ ìƒì„¸ ì •ë³´ ì¡°íšŒ
   - ì¹´í…Œê³ ë¦¬ì— ë§ëŠ” AI í”„ë¡¬í”„íŠ¸ ì„ íƒ

2. **íƒ€ì´í‹€ ìë™ ìƒì„±**
   - ìƒí’ˆ ì •ë³´ ê¸°ë°˜ AI íƒ€ì´í‹€ ìƒì„±
   - `video_titles` í…Œì´ë¸”ì— ì €ì¥
   - ìƒí’ˆ ì¹´í…Œê³ ë¦¬ë³„ë¡œ ë§ì¶¤í˜• íƒ€ì´í‹€ ìƒì„±

3. **ì¹´í…Œê³ ë¦¬ë³„ ìŠ¤ì¼€ì¤„ ìë™ ë“±ë¡**
   - ì¹´í…Œê³ ë¦¬ì— ë”°ë¼ ì±„ë„ ìë™ ë°°ì • (ì˜ˆ: "ì˜ë¥˜" â†’ íŒ¨ì…˜ ì±„ë„)
   - `task_schedules` í…Œì´ë¸”ì— INSERT
   - ìë™ìœ¼ë¡œ ìŠ¤ì¼€ì¤„ ì‹œê°„ ì„¤ì • (ì¹´í…Œê³ ë¦¬ë³„ ìµœì  ì—…ë¡œë“œ ì‹œê°„)
   - YouTube í”„ë¼ì´ë²„ì‹œ: 'public'ìœ¼ë¡œ ì„¤ì •

4. **ìƒíƒœ ì—…ë°ì´íŠ¸**
   - `video_titles` ìƒíƒœ: 'pending' â†’ 'scheduled'
   - `task_schedules` ìƒíƒœ: 'pending'

**êµ¬í˜„ ìœ„ì¹˜**:
- `src/app/api/automation/test-generate-stream/route.ts` - ë©”ì¸ ë¡œì§ (Step 1, 2)
- `src/app/api/automation/[category]/auto-schedule/route.ts` - ì¹´í…Œê³ ë¦¬ë³„ ìë™ ìŠ¤ì¼€ì¤„ (Step 3) **[í•„ìš”]**
- `src/lib/coupang-deeplink.ts` - ë”¥ë§í¬ ìƒì„±
- `src/lib/automation.ts` - DB ì¿¼ë¦¬ í•¨ìˆ˜

**ê´€ë ¨ í…Œì´ë¸”**:
```sql
-- coupang_products: ë‚´ëª©ë¡ ìƒí’ˆ
CREATE TABLE coupang_products (
  id TEXT PRIMARY KEY,
  product_id TEXT,
  product_name TEXT,
  deep_link TEXT,
  category_id TEXT,          -- ì¹´í…Œê³ ë¦¬ ID
  image_url TEXT,
  original_price INTEGER,
  discount_price INTEGER,
  status TEXT DEFAULT 'active'
);

-- video_titles: ìƒì„±ëœ íƒ€ì´í‹€
CREATE TABLE video_titles (
  id TEXT PRIMARY KEY,
  title TEXT,
  type TEXT,
  category TEXT,             -- ì¹´í…Œê³ ë¦¬ ('ì˜ë¥˜', 'ê°€ì „', 'ì‹í’ˆ' ë“±)
  product_url TEXT,          -- ì¿ íŒ¡ ë”¥ë§í¬
  status TEXT DEFAULT 'pending'
);

-- task_schedules: ì˜ˆì•½í + ë©”íƒ€ì •ë³´
CREATE TABLE task_schedules (
  id TEXT PRIMARY KEY,
  task_id TEXT,               -- íŒŒì´í”„ë¼ì¸ ì „ì²´ ì‹ë³„ì
  title_id TEXT NOT NULL,
  user_id TEXT,
  scheduled_time DATETIME NOT NULL,
  youtube_publish_time DATETIME,
  youtube_privacy TEXT DEFAULT 'public',
  youtube_url TEXT,
  channel_setting_id TEXT,    -- ì¹´í…Œê³ ë¦¬ë³„ ìë™ ë°°ì • ì±„ë„
  media_mode TEXT DEFAULT 'upload',
  status TEXT DEFAULT 'pending',
  script_id TEXT,
  video_id TEXT,
  youtube_upload_id TEXT,
  error TEXT,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

**íŠ¹ì§•**:
- âœ… ì™„ì „ ìë™í™”: ì‚¬ìš©ì ê°œì… ì—†ìŒ
- âœ… ì‹ ê·œ ìƒí’ˆë§Œ ë“±ë¡: ë‚´ëª©ë¡ ì¤‘ë³µ ì²´í¬
- âœ… ì¹´í…Œê³ ë¦¬ ë§ì¶¤: ì¹´í…Œê³ ë¦¬ë³„ ì±„ë„/íƒ€ì´í‹€ ìµœì í™”
- âœ… ì¦‰ì‹œ ìŠ¤ì¼€ì¤„: ë“±ë¡ í›„ ìë™ìœ¼ë¡œ ì˜ˆì•½í ìƒì„±

**ìƒíƒœ**: âš ï¸ ë¶€ë¶„ êµ¬í˜„ (Step 1, 2ëŠ” ì™„ë£Œ, Step 3 ë¯¸êµ¬í˜„)

---

## ìƒí’ˆ íƒ€ì´í‹€ ìë™ ìƒì„±

**êµ¬í˜„ ìœ„ì¹˜**: `src/app/api/automation/titles/route.ts`

**ë™ì‘ íë¦„**:
1. **ìƒí’ˆ ì •ë³´ ì¡°íšŒ**
   - ì¿ íŒ¡ ìƒí’ˆ URLì—ì„œ ìƒí’ˆ ID ì¶”ì¶œ
   - APIë¥¼ í†µí•´ ìƒí’ˆ ì´ë¦„, ê°€ê²©, ì¹´í…Œê³ ë¦¬ ë“± ì¡°íšŒ

2. **AI íƒ€ì´í‹€ ìƒì„±**
   - ìƒí’ˆ ì •ë³´ë¥¼ ê¸°ë°˜ìœ¼ë¡œ í”„ë¡¬í”„íŠ¸ ìƒì„±
   - Claude/ChatGPT API í˜¸ì¶œ
   - ìœ íŠœë¸Œ ìµœì í™” íƒ€ì´í‹€ ìƒì„±

3. **íƒ€ì´í‹€ ì €ì¥**
   - `video_titles` í…Œì´ë¸”ì— ì €ì¥
   - ìƒí’ˆ ì •ë³´(JSON) í•¨ê»˜ ì €ì¥

**ê´€ë ¨ íŒŒì¼**:
- `src/app/api/automation/titles/route.ts` - íƒ€ì´í‹€ API
- `src/lib/automation.ts` - DB ì¿¼ë¦¬ í•¨ìˆ˜

**ìƒíƒœ**: âš ï¸ ë¶€ë¶„ êµ¬í˜„ (ìˆ˜ë™ ì…ë ¥ì€ ê°€ëŠ¥, ìë™ ìƒì„±ì€ ë¯¸êµ¬í˜„)

---

## ìë™í™” ìŠ¤ì¼€ì¤„ ê´€ë¦¬

**êµ¬í˜„ ìœ„ì¹˜**: `src/app/api/automation/schedules/route.ts`

**ë™ì‘ íë¦„**:
1. **ìŠ¤ì¼€ì¤„ ìƒì„±**
   - íƒ€ì´í‹€ ì„ íƒ
   - ì±„ë„ ì„ íƒ
   - ì—…ë¡œë“œ ë‚ ì§œ/ì‹œê°„ ì„¤ì •
   - YouTube í”„ë¼ì´ë²„ì‹œ ì„¤ì •

2. **ìŠ¤ì¼€ì¤„ ì¡°íšŒ**
   - ì±„ë„ë³„ ìŠ¤ì¼€ì¤„ ì¡°íšŒ
   - ìƒíƒœë³„ ìŠ¤ì¼€ì¤„ í•„í„°ë§ (pending, processing, completed, failed, cancelled)
   - ë‹¬ë ¥ ë·°ë¡œ ì¡°íšŒ

3. **ìŠ¤ì¼€ì¤„ ì‹¤í–‰**
   - `task_schedules` í…Œì´ë¸”ì—ì„œ pending ìƒíƒœ ì¡°íšŒ
   - ìë™í™” ìŠ¤ì¼€ì¤„ëŸ¬ê°€ ì´ë¥¼ ì²˜ë¦¬

**ê´€ë ¨ íŒŒì¼**:
- `src/app/api/automation/schedules/route.ts` - ìŠ¤ì¼€ì¤„ ê´€ë¦¬ API
- `src/app/api/automation/calendar/route.ts` - ìº˜ë¦°ë” ì¡°íšŒ API
- `src/lib/automation.ts` - DB ì¿¼ë¦¬ í•¨ìˆ˜
- `src/lib/automation-scheduler.ts` - ìŠ¤ì¼€ì¤„ ì‹¤í–‰ ë¡œì§

**ìƒíƒœ**: âœ… ì™„ë£Œ

---

## ìë™í™” ìŠ¤ì¼€ì¤„ëŸ¬ (ìë™ ì‹¤í–‰)

**êµ¬í˜„ ìœ„ì¹˜**: `src/lib/automation-scheduler.ts`

### ğŸ“‹ ì™„ì „í•œ ìë™í™” íŒŒì´í”„ë¼ì¸

```
[Stage 1: ëŒ€ë³¸ ìƒì„±]           [Stage 2: ì˜ìƒ ìƒì„±]           [Stage 3: ì—…ë¡œë“œ]           [Stage 4: í¼ë¸”ë¦¬ì‹œ]
        â†“                              â†“                           â†“                          â†“
  ìŠ¤í¬ë¦½íŠ¸ ìƒì„± API        ì´ë¯¸ì§€/ì˜ìƒ ìƒì„± API       YouTube ì—…ë¡œë“œ API      í¼ë¸”ë¦¬ì‹œ ì˜ˆì•½
```

---

### **Step 1: ìŠ¤ì¼€ì¤„ ê°ì‹œ ë° ì²˜ë¦¬ (3ì´ˆ ê°„ê²©)**

#### 1-1. Pending ìŠ¤ì¼€ì¤„ ê°ì‹œ
- **í•¨ìˆ˜**: `processPendingSchedules()` (Line 150)
- **ë™ì‘**:
  - `task_schedules` í…Œì´ë¸”ì—ì„œ `status='pending'` ìŠ¤ì¼€ì¤„ ì¡°íšŒ
  - `scheduled_time <= í˜„ì¬ì‹œê°„` ìŠ¤ì¼€ì¤„ë§Œ ì²˜ë¦¬
  - ì¡°íšŒ ì‹œ í•¨ê»˜ ê°€ì ¸ì˜¤ëŠ” ì •ë³´:
    - ì œëª©, íƒ€ì…, ì¹´í…Œê³ ë¦¬, íƒœê·¸
    - **media_mode** (upload / dalle / imagen3 / sora2) âœ… NEW
    - ëª¨ë¸ ì •ë³´, YouTube ì„¤ì •

#### 1-2. íŒŒì´í”„ë¼ì¸ ìƒì„± (tasks_queue ê¸°ë°˜)
- **í•¨ìˆ˜**: QueueManager.createPipeline() ë˜ëŠ” ì§ì ‘ enqueue
- **ë™ì‘**:
  - 4ë‹¨ê³„ íŒŒì´í”„ë¼ì¸ ìƒì„±:
    1. script (ëŒ€ë³¸ ìƒì„±)
    2. image (ì´ë¯¸ì§€ í¬ë¡¤ë§)
    3. video (ì˜ìƒ ìƒì„±)
    4. youtube (YouTube ì—…ë¡œë“œ)
  - ê° ë‹¨ê³„ë¥¼ `tasks_queue` í…Œì´ë¸”ì— ê¸°ë¡ (ë³µí•© PK: task_id + type)

---

### **Step 2: ëŒ€ë³¸ ìƒì„± (Stage 1: Script)**

#### 2-1. API í˜¸ì¶œ
- **API**: `POST /api/scripts/generate`
- **ì „ë‹¬ ì •ë³´**:
  - title: ì œëª©
  - type: ì½˜í…ì¸  íƒ€ì… (product, longform, shortform, sora2)
  - model: AI ëª¨ë¸ (claude, chatgpt, gemini, groq)
  - productInfo: ìƒí’ˆ ì •ë³´ (ìƒí’ˆ íƒ€ì…ì¼ ê²½ìš°)
  - category: ì¹´í…Œê³ ë¦¬

#### 2-2. ê²°ê³¼ ì €ì¥
- `contents` í…Œì´ë¸”ì— ëŒ€ë³¸ ì €ì¥
- `task_schedules`ì— `script_id` ê¸°ë¡
- `tasks_queue`ì˜ script ìƒíƒœë¥¼ 'completed'ë¡œ ì—…ë°ì´íŠ¸

#### 2-3. ì¤‘ìš”: ì§ì ‘ ì—…ë¡œë“œ ëª¨ë“œ ê°ì§€ â­
```typescript
if (mediaMode === 'upload') {
  // story.json ìƒì„±
  // waiting_for_upload ìƒíƒœë¡œ ë³€ê²½
  // return â†’ ì˜ìƒ ìƒì„± ìŠ¤í‚µ!

  updateScheduleStatus(schedule.id, 'waiting_for_upload', { scriptId });
  addTitleLog(schedule.title_id, 'info', 'â¸ï¸ ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.');
  return; // ì—¬ê¸°ì„œ ë©ˆì¶¤!
}
```
- **ì˜ë¯¸**: ì‚¬ìš©ìê°€ ì´ë¯¸ì§€ë¥¼ ì§ì ‘ ì¤€ë¹„í•  ë•Œê¹Œì§€ ëŒ€ê¸°
- **ë‹¤ìŒ ë‹¨ê³„**: ì‚¬ìš©ìê°€ "ì´ë¯¸ì§€ í¬ë¡¤ë§" ë²„íŠ¼ í´ë¦­

---

### **Step 3: ì´ë¯¸ì§€ ì—…ë¡œë“œ ëŒ€ê¸° (ì¤‘ë‹¨ì )**

#### 3-1. ìƒíƒœ: `waiting_for_upload`
- **ì¡°íšŒ í•¨ìˆ˜**: `getWaitingForUploadSchedules()` (Line 1271)
- **ë™ì‘**:
  - ìŠ¤ì¼€ì¤„ëŸ¬ê°€ 3ì´ˆë§ˆë‹¤ waiting_for_upload ìŠ¤ì¼€ì¤„ í™•ì¸
  - task í´ë”ì—ì„œ ì´ë¯¸ì§€ íŒŒì¼ ê°ì§€
    ```
    task_{task_id}/
      â”œâ”€â”€ story.json
      â”œâ”€â”€ scene_01_image.png    â† ê°ì§€!
      â”œâ”€â”€ scene_02_image.png
      â””â”€â”€ ...
    ```

#### 3-2. ì‚¬ìš©ì ì•¡ì…˜: ì´ë¯¸ì§€ í¬ë¡¤ë§
- **UI**: ìë™í™” í˜ì´ì§€ â†’ "ğŸ–¼ï¸ ì´ë¯¸ì§€ í¬ë¡¤ë§" ë²„íŠ¼
- **ë™ì‘**:
  1. `/api/crawl-images` API í˜¸ì¶œ ë˜ëŠ” ìë™ í ì²˜ë¦¬
  2. ëŒ€ë³¸ì˜ ê° sceneë§ˆë‹¤ ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ
  3. `task_{task_id}/` í´ë”ì— ì €ì¥
  4. scene_01_image.png, scene_02_image.png, ... í˜•íƒœë¡œ ì €ì¥

#### 3-3. ì´ë¯¸ì§€ ê°ì§€ ë° ìë™ ì§„í–‰
- **í•¨ìˆ˜**: `checkWaitingForUploadSchedules()` (Line 1271)
- **ë™ì‘**:
  ```typescript
  if (imageFiles.length > 0) {
    // âœ… ì´ë¯¸ì§€ ê°ì§€!
    updateScheduleStatus(schedule.id, 'processing');
    resumeVideoGeneration(schedule, videoPipelineId); // ì˜ìƒ ìƒì„± ì¬ê°œ
  }
  ```

---

### **Step 4: ì˜ìƒ ìƒì„± (Stage 2: Video)**

#### 4-1. í•¨ìˆ˜: `generateVideo()` (Line 736)

#### 4-2. ì‚¬ì „ ì¤€ë¹„
```typescript
const mediaMode = schedule.media_mode || 'upload'; // âœ… ì§ì ‘ ì—…ë¡œë“œë©´ 'upload'
const imageSource = (mediaMode === 'upload' || hasUploadedImages) ? 'none' : mediaMode;
```
- **imageSource='none'**: ì§ì ‘ ì—…ë¡œë“œí•œ ì´ë¯¸ì§€ ì‚¬ìš© (ìë™ ìƒì„± X)
- **imageSource='dalle'**: DALL-E ì´ìš©í•´ ì´ë¯¸ì§€ ìë™ ìƒì„±
- **imageSource='imagen3'**: Google Imagen3 ì´ìš©í•´ ì´ë¯¸ì§€ ìë™ ìƒì„±

#### 4-3. Python ë°±ì—”ë“œ í˜¸ì¶œ
```bash
python create_video_from_folder.py \
  --folder input/task_{task_id} \
  --image-source {imageSource} \
  --aspect-ratio {16:9 or 9:16} \
  --voice ko-KR-SoonBokNeural \
  --image-provider {openai or imagen3} \
  --task-id {task_id}
```

#### 4-4. ë°±ì—”ë“œ ì²˜ë¦¬
**íŒŒì¼**: `trend-video-backend/create_video_from_folder.py`
- story.json + ì´ë¯¸ì§€ë¡œ ì˜ìƒ ìƒì„±
- **ì¤‘ìš”**: imageSource='none'ì´ë©´ ìë™ ìƒì„± ì•ˆí•¨
  ```python
  if self.image_source in ["google", "dalle", "imagen3"]:
      images = self._download_missing_images(images)
  # else: ì•„ë¬´ê²ƒë„ ì•ˆí•¨ (ì§ì ‘ ì—…ë¡œë“œ ì´ë¯¸ì§€ë§Œ ì‚¬ìš©)
  ```

#### 4-5. ì˜ìƒ ì €ì¥
- MP4 íŒŒì¼ ìƒì„±
- `task_schedules`ì— `video_id` ê¸°ë¡
- `tasks_queue`ì˜ video ìƒíƒœë¥¼ 'completed'ë¡œ ì—…ë°ì´íŠ¸

---

### **Step 5: YouTube ì—…ë¡œë“œ (Stage 3: Upload)**

#### 5-1. í•¨ìˆ˜: `uploadToYouTube()` (Line 921)

#### 5-2. ì—…ë¡œë“œ ì „ ì²˜ë¦¬
- ì˜ìƒ ë©”íƒ€ë°ì´í„° ì¤€ë¹„:
  - ì œëª©: `[ê´‘ê³ ] {ìƒí’ˆëª…}` (ìƒí’ˆì¸ ê²½ìš°)
  - ì„¤ëª…: ìƒí’ˆ ì„¤ëª… + êµ¬ë§¤ ë§í¬ (ìƒí’ˆì¸ ê²½ìš°)
  - íƒœê·¸: ì¹´í…Œê³ ë¦¬, ì±„ë„, íƒœê·¸
  - ì¸ë„¤ì¼: ì²« í”„ë ˆì„ ë˜ëŠ” ìƒí’ˆ ì´ë¯¸ì§€

#### 5-3. YouTube API í˜¸ì¶œ
- OAuth 2.0 ì¸ì¦
- `youtube.videos().insert()` í˜¸ì¶œ
- íŒŒì¼ ì—…ë¡œë“œ
- ë©”íƒ€ë°ì´í„° ì„¤ì •

#### 5-4. ê²°ê³¼ ì €ì¥
- `youtube_uploads` í…Œì´ë¸”ì— ì—…ë¡œë“œ ê¸°ë¡
- `task_schedules`ì— `youtube_upload_id`, `youtube_url` ê¸°ë¡
- `tasks_queue`ì˜ youtube ìƒíƒœë¥¼ 'completed'ë¡œ ì—…ë°ì´íŠ¸

---

### **Step 6: YouTube í¼ë¸”ë¦¬ì‹œ (Stage 4: Publish)**

#### 6-1. í•¨ìˆ˜: `scheduleYouTubePublish()` (Line 1016)

#### 6-2. í¼ë¸”ë¦¬ì‹œ ì„¤ì •
- **ì˜µì…˜ 1**: Immediate (ì¦‰ì‹œ ê³µê°œ)
  ```typescript
  if (schedule.youtube_schedule === 'immediate') {
    // ë°”ë¡œ ê³µê°œ
  }
  ```

- **ì˜µì…˜ 2**: Scheduled (ì˜ˆì•½ ê³µê°œ)
  ```typescript
  if (schedule.youtube_schedule === 'scheduled') {
    youtube.videos().update({
      publishAt: schedule.youtube_publish_time // ISO ì‹œê°„
    });
  }
  ```

#### 6-3. ìµœì¢… ìƒíƒœ ì—…ë°ì´íŠ¸
- `task_schedules` ìƒíƒœ: 'completed'
- `video_titles` ìƒíƒœ: 'completed'
- `tasks_queue`(video/upload) ìƒíƒœ: 'completed' ê¸°ë¡
- `automation_pipelines` ëª¨ë“  ë‹¨ê³„: 'completed' (í˜¸í™˜ìš©)

---

### **Step 7: ìˆí¼ ìë™ ìƒì„± (ë¡±í¼ì¸ ê²½ìš°)**

#### 7-1. ìë™ íŠ¸ë¦¬ê±°
```typescript
if (schedule.type === 'longform') {
  // ë¡±í¼ ì™„ë£Œ â†’ ìë™ìœ¼ë¡œ ìˆí¼ ìƒì„±
  uploadShortForm(videoResult.videoUrl);
}
```

#### 7-2. ìˆí¼ ìƒì„± í”„ë¡œì„¸ìŠ¤
- ë¡±í¼ ì˜ìƒì—ì„œ ì£¼ìš” ì¥ë©´ ì¶”ì¶œ
- ìë§‰ ì¶”ì¶œ + ìŒì„± ì¶”ì¶œ
- 15ì´ˆ~60ì´ˆ ìˆí¼ í´ë¦½ ìƒì„±
- YouTube Shortsë¡œ ì—…ë¡œë“œ

---

### ğŸ“Š ìƒíƒœ ê´€ë¦¬ íë¦„

```
pending
   â†“
[Stage 1: Script Generation]
   â†“
waiting_for_upload (ì§ì ‘ì—…ë¡œë“œì¸ ê²½ìš°ë§Œ)
   â†“ [ì‚¬ìš©ì: ì´ë¯¸ì§€ í¬ë¡¤ë§]
processing
   â†“
[Stage 2: Video Generation]
   â†“
[Stage 3: YouTube Upload]
   â†“
[Stage 4: Publish]
   â†“
completed
```

**ì‹¤íŒ¨ ì‹œ**:
- `status='failed'`
- `automation_pipelines`ì— error_message ê¸°ë¡
- ì¬ì‹œë„ ë¡œì§: max_retryë§Œí¼ ìë™ ì¬ì‹œë„
- ìµœì¢… ì‹¤íŒ¨ ì‹œ ì‚¬ìš©ì ì•Œë¦¼

---

### ğŸ”‘ Key Features

1. **ì™„ì „ ìë™í™”**: 4ë‹¨ê³„ íŒŒì´í”„ë¼ì¸ ìë™ ì²˜ë¦¬
2. **ì¤‘ë‹¨ì **: ì§ì ‘ ì—…ë¡œë“œ ì„ íƒ ì‹œ ì´ë¯¸ì§€ ì¤€ë¹„í•  ë•Œê¹Œì§€ ëŒ€ê¸°
3. **ì´ë¯¸ì§€ ê°ì§€**: ìë™ìœ¼ë¡œ ì´ë¯¸ì§€ ê°ì§€ â†’ ìë™ ì¬ê°œ
4. **ì—ëŸ¬ ì²˜ë¦¬**: ê° ë‹¨ê³„ë³„ ì—ëŸ¬ ê¸°ë¡ + ì¬ì‹œë„
5. **ë¡œê·¸ ê´€ë¦¬**: ì‹¤ì‹œê°„ ì§„í–‰ ìƒí™© ë¡œê¹…
6. **ë¡±í¼â†’ìˆí¼**: ë¡±í¼ ì™„ë£Œ í›„ ìë™ ìˆí¼ ìƒì„±

---

**ê´€ë ¨ íŒŒì¼**:
- `src/lib/automation-scheduler.ts` - ìŠ¤ì¼€ì¤„ëŸ¬ ë©”ì¸ ë¡œì§ (1500+ ë¼ì¸)
- `src/lib/automation.ts` - DB ì¿¼ë¦¬ ë° í—¬í¼ í•¨ìˆ˜
- `src/app/api/scripts/generate/route.ts` - ëŒ€ë³¸ ìƒì„± API
- `src/app/api/generate-video-upload/route.ts` - ì˜ìƒ ìƒì„± API
- `src/app/api/youtube/upload/route.ts` - YouTube ì—…ë¡œë“œ API
- `trend-video-backend/create_video_from_folder.py` - ì˜ìƒ ìƒì„± Python
- `trend-video-backend/src/video_generator/long_form_creator.py` - ë¡±í¼ ìƒì„±

**ì£¼ìš” í•¨ìˆ˜**:
- `startAutomationScheduler()` - ìŠ¤ì¼€ì¤„ëŸ¬ ì‹œì‘
- `processPendingSchedules()` - pending ìŠ¤ì¼€ì¤„ ì²˜ë¦¬
- `checkWaitingForUploadSchedules()` - ì´ë¯¸ì§€ ì—…ë¡œë“œ ëŒ€ê¸° ìŠ¤ì¼€ì¤„ í™•ì¸ â­ NEW
- `resumeVideoGeneration()` - ì´ë¯¸ì§€ ê°ì§€ í›„ ì˜ìƒ ìƒì„± ì¬ê°œ â­ NEW
- `executePipeline()` - ì „ì²´ íŒŒì´í”„ë¼ì¸ ì‹¤í–‰
- `generateScript()` - Stage 1
- `generateVideo()` - Stage 2
- `uploadToYouTube()` - Stage 3
- `scheduleYouTubePublish()` - Stage 4

**ìƒíƒœ**: âœ… ì™„ë£Œ (ì§ì ‘ì—…ë¡œë“œ + ì´ë¯¸ì§€ ê°ì§€ í¬í•¨)

---

## ê¸€ë¡œë²Œ í ì‹œìŠ¤í…œ (Global Queue Management) - task_id ê¸°ë°˜

**êµ¬í˜„ ìœ„ì¹˜**: `src/lib/queue-manager.ts`

### ğŸ“‹ ê°œìš”

ì„œë²„ ì „ì²´ì˜ ë¦¬ì†ŒìŠ¤ë¥¼ ê´€ë¦¬í•˜ëŠ” í ì‹œìŠ¤í…œ. **ë‹¨ì¼ task_id**ë¡œ ì „ì²´ íŒŒì´í”„ë¼ì¸ì„ ì‹ë³„í•˜ê³ , ê° ì‘ì—… íƒ€ì…(script, image, video, youtube)ë³„ë¡œ **1ê°œì”©ë§Œ ë™ì‹œ ì‹¤í–‰**ì„ ë³´ì¥í•©ë‹ˆë‹¤.

### ğŸ†” task_id í†µì¼ ê°œë…

```
task_id = "task_1234567890_abc123"

í•˜ë‚˜ì˜ task_idë¡œ ì „ì²´ íŒŒì´í”„ë¼ì¸ ì‹ë³„:
â”œâ”€â”€ script   (ëŒ€ë³¸ ìƒì„±)
â”œâ”€â”€ image    (ì´ë¯¸ì§€ í¬ë¡¤ë§)
â”œâ”€â”€ video    (ì˜ìƒ ìƒì„±)
â””â”€â”€ youtube  (YouTube ì—…ë¡œë“œ)

í´ë” êµ¬ì¡°: task_{task_id}/
         â””â”€â”€ scene_1.png, scene_2.png, story.json ...
```

### ğŸ—„ï¸ ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ

```sql
-- tasks_queue: íŒŒì´í”„ë¼ì¸ ì‘ì—… í…Œì´ë¸” (ë³µí•© PK: task_id + type)
CREATE TABLE tasks_queue (
  task_id TEXT NOT NULL,                -- íŒŒì´í”„ë¼ì¸ ì „ì²´ ì‹ë³„ì
  type TEXT NOT NULL CHECK(type IN ('script', 'image', 'video', 'youtube')),
  status TEXT NOT NULL CHECK(status IN ('waiting', 'processing', 'completed', 'failed')),
  priority INTEGER DEFAULT 0,
  created_at TEXT NOT NULL,
  started_at TEXT,
  completed_at TEXT,
  user_id TEXT NOT NULL,
  metadata TEXT,                         -- JSON (scenes, scheduleId, titleId ë“±)
  logs TEXT,                             -- JSON ë°°ì—´
  error TEXT,
  retry_count INTEGER DEFAULT 0,
  max_retries INTEGER DEFAULT 3,
  PRIMARY KEY (task_id, type)
);

-- tasks_locks: íƒ€ì…ë³„ ë½ í…Œì´ë¸” (ë™ì‹œ 1ê°œ ë³´ì¥)
CREATE TABLE tasks_locks (
  task_type TEXT PRIMARY KEY CHECK(task_type IN ('script', 'image', 'video', 'youtube')),
  locked_by TEXT,                        -- í˜„ì¬ ì²˜ë¦¬ ì¤‘ì¸ task_id
  locked_at TEXT,
  worker_pid INTEGER
);

```

### ğŸ”§ QueueManager í´ë˜ìŠ¤

**ì£¼ìš” ë©”ì„œë“œ**:

| ë©”ì„œë“œ | ì„¤ëª… |
|--------|------|
| `createPipeline({userId, metadata})` | ìƒˆ íŒŒì´í”„ë¼ì¸ ìƒì„± (4ë‹¨ê³„ ëª¨ë‘ ìƒì„±, task_id ë°˜í™˜) |
| `enqueue(task)` | íŠ¹ì • ë‹¨ê³„ íì— ì¶”ê°€ |
| `dequeue(type)` | íì—ì„œ ë‹¤ìŒ ì‘ì—… ê°€ì ¸ì˜¤ê¸° (ì´ì „ ë‹¨ê³„ ì™„ë£Œëœ ê²ƒë§Œ) |
| `getTask(taskId, type)` | íŠ¹ì • ë‹¨ê³„ ìƒíƒœ ì¡°íšŒ |
| `getPipeline(taskId)` | íŒŒì´í”„ë¼ì¸ ì „ì²´ ìƒíƒœ ì¡°íšŒ |
| `getCurrentStage(taskId)` | í˜„ì¬ ì§„í–‰ ì¤‘ì¸ ë‹¨ê³„ ì¡°íšŒ |
| `updateTask(taskId, type, updates)` | íŠ¹ì • ë‹¨ê³„ ìƒíƒœ ì—…ë°ì´íŠ¸ |
| `releaseTask(taskId, type)` | ì‘ì—… ì™„ë£Œ í›„ ë½ í•´ì œ |
| `appendLog(taskId, type, message)` | ë¡œê·¸ ì¶”ê°€ |

**ì‚¬ìš© ì˜ˆì‹œ**:
```typescript
import { QueueManager } from '@/lib/queue-manager';

const queueManager = new QueueManager();

// ì´ë¯¸ì§€ í¬ë¡¤ë§ í ë“±ë¡ (task_id ê¸°ë°˜)
await queueManager.enqueue({
  taskId: 'task_1234567890_abc123',
  type: 'image',
  userId: 'user_1',
  priority: 0,
  metadata: {
    scenes: [...],
    scheduleId: 'schedule_456',
    titleId: 'title_789'
  },
  logs: [],
  retryCount: 0,
  maxRetries: 3
});

// íŠ¹ì • ë‹¨ê³„ ìƒíƒœ í™•ì¸
const imageStatus = await queueManager.getTask('task_1234567890_abc123', 'image');
console.log(imageStatus.status); // 'waiting' | 'processing' | 'completed' | 'failed'

// ì „ì²´ íŒŒì´í”„ë¼ì¸ ìƒíƒœ í™•ì¸
const pipeline = await queueManager.getPipeline('task_1234567890_abc123');
// [{ type: 'script', status: 'completed' }, { type: 'image', status: 'processing' }, ...]

queueManager.close();
```

### ğŸ”’ ë™ì‹œì„± ì œì–´

- **íƒ€ì…ë³„ 1ê°œ ì²˜ë¦¬**: `tasks_locks` í…Œì´ë¸”ë¡œ ê° íƒ€ì…ë³„ ë™ì‹œ 1ê°œë§Œ ì²˜ë¦¬
- **ë‹¨ê³„ë³„ ì˜ì¡´ì„±**: ì´ì „ ë‹¨ê³„ ì™„ë£Œ ì‹œì—ë§Œ ë‹¤ìŒ ë‹¨ê³„ dequeue ê°€ëŠ¥
  - `image` â†’ `script` ì™„ë£Œ í•„ìš”
  - `video` â†’ `image` ì™„ë£Œ í•„ìš”
  - `youtube` â†’ `video` ì™„ë£Œ í•„ìš”
- **íŠ¸ëœì­ì…˜ ë½**: SQLite íŠ¸ëœì­ì…˜ìœ¼ë¡œ race condition ë°©ì§€
- **ìë™ ì¬ì‹œë„**: ì‹¤íŒ¨ ì‹œ `max_retries`ê¹Œì§€ ìë™ ì¬ì‹œë„

---

## Phase 4: ìë™í™” í†µí•© (Automation Integration) - task_id ê¸°ë°˜

**êµ¬í˜„ ìœ„ì¹˜**: `src/lib/automation-scheduler.ts`

### ğŸ“‹ ê°œìš”

ëŒ€ë³¸ ìƒì„± ì™„ë£Œ í›„ **ìë™ìœ¼ë¡œ ì´ë¯¸ì§€ í¬ë¡¤ë§**ì„ ì‹œì‘í•˜ê³ , ì™„ë£Œë˜ë©´ **ìë™ìœ¼ë¡œ ì˜ìƒ ìƒì„± ë° YouTube ì—…ë¡œë“œ**ê¹Œì§€ ì§„í–‰í•˜ëŠ” ì™„ì „ ìë™í™” íŒŒì´í”„ë¼ì¸.

**í•µì‹¬ ë³€ê²½**: `task_id`ë¡œ ì „ì²´ íŒŒì´í”„ë¼ì¸ì„ í†µì¼ ê´€ë¦¬
- í´ë”: `task_{task_id}/`
- DB: `task_schedules.id`, `tasks_queue (task_id + type)`

### ğŸ”„ ì™„ì „ ìë™í™” íë¦„ (task_id ê¸°ë°˜)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Phase 4: ì™„ì „ ìë™í™” íŒŒì´í”„ë¼ì¸ (task_id í†µì¼)                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

[1] ìŠ¤ì¼€ì¤„ ì‹¤í–‰ (pending â†’ processing)
    â”‚  - task_id ìƒì„±: "task_1234567890_abc123"
    â”‚  - task_schedules.id ì €ì¥
    â”‚  - í´ë” ìƒì„±: task_{task_id}/
    â”‚
    â–¼
[2] ëŒ€ë³¸ ìƒì„± (Stage 1: Script)
    â”‚  - generateScript() í˜¸ì¶œ
    â”‚  - contents í…Œì´ë¸”ì— ì €ì¥
    â”‚  - story.json â†’ task_{task_id}/story.json
    â”‚
    â–¼
[3] ì§ì ‘ ì—…ë¡œë“œ ëª¨ë“œ ì²´í¬ (media_mode === 'upload')
    â”‚
    â”œâ”€â”€ YES â”€â”€â–¶ [4] ì´ë¯¸ì§€ í¬ë¡¤ë§ í ìë™ ë“±ë¡
    â”‚           â”‚  - QueueManager.enqueue({taskId, type:'image', ...})
    â”‚           â”‚  - tasks_queueì— task_id + 'image' ë ˆì½”ë“œ ì¶”ê°€
    â”‚           â”‚  - status: 'waiting_for_upload'
    â”‚           â”‚
    â”‚           â–¼
    â”‚       [5] ì´ë¯¸ì§€ í¬ë¡¤ë§ ì™„ë£Œ ëŒ€ê¸°
    â”‚           â”‚  - checkWaitingForUploadSchedules() 3ì´ˆë§ˆë‹¤ ì‹¤í–‰
    â”‚           â”‚  - queueManager.getTask(task_id, 'image') ìƒíƒœ í™•ì¸
    â”‚           â”‚  - completed ì‹œ ë‹¤ìŒ ë‹¨ê³„ë¡œ
    â”‚           â”‚
    â”‚           â–¼
    â”‚       [6] ì˜ìƒ ìƒì„± ìë™ ì‹œì‘ (Stage 2: Video)
    â”‚           â”‚  - resumeVideoGeneration() í˜¸ì¶œ
    â”‚           â”‚  - í´ë”: task_{task_id}/
    â”‚
    â””â”€â”€ NO â”€â”€â”€â–¶ [6] ì˜ìƒ ìƒì„± (ìë™ ì´ë¯¸ì§€ ìƒì„±)
                â”‚  - DALL-E / Imagen3 / Sora2 ì‚¬ìš©
                â”‚
                â–¼
            [7] YouTube ì—…ë¡œë“œ (Stage 3: Upload)
                â”‚  - uploadToYouTube() í˜¸ì¶œ
                â”‚  - youtube_url ì €ì¥
                â”‚
                â–¼
            [8] ì™„ë£Œ (status: 'completed')
```

### ğŸ—„ï¸ ë°ì´í„° êµ¬ì¡°

```sql
-- task_schedulesëŠ” ê¸°ë³¸ í‚¤(id)ë¡œ task_idë¥¼ ì‚¬ìš©

-- tasks_queue í…Œì´ë¸” (task_id + type ë³µí•© PK)
-- í•˜ë‚˜ì˜ task_idì— 4ê°œ ë ˆì½”ë“œ: script, image, video, youtube
```

### ğŸ”§ ì£¼ìš” í•¨ìˆ˜

#### 1. task_id ìƒì„± ë° ìŠ¤ì¼€ì¤„ ì‹œì‘ (Line 177-188)

```typescript
// processPendingSchedules() ë‚´ë¶€
const taskId = `task_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;

db.prepare(`
  -- task_schedulesëŠ” task_id(id) ê¸°ì¤€ìœ¼ë¡œ ìƒíƒœ ì—…ë°ì´íŠ¸
  SET status = 'processing', task_id = ?, updated_at = CURRENT_TIMESTAMP
  WHERE id = ? AND status = 'pending'
`).run(taskId, schedule.id);

schedule.task_id = taskId;
```

#### 2. í´ë” ìƒì„± ë° ì´ë¯¸ì§€ í¬ë¡¤ë§ í ë“±ë¡ (Line 305-410)

```typescript
// executePipeline() ë‚´ë¶€, mediaMode === 'upload' ë¶„ê¸°
const projectFolderPath = path.join(BACKEND_PATH, 'input', `task_${schedule.task_id}`);

if (storyJson.scenes && storyJson.scenes.length > 0) {
  await queueManager.enqueue({
    taskId: schedule.task_id,  // task_id ê¸°ë°˜
    type: 'image',
    userId: schedule.user_id || 'system',
    priority: 0,
    metadata: {
      scenes: storyJson.scenes,
      scheduleId: schedule.id,
      titleId: schedule.title_id,
      format: schedule.type || 'shortform'
    },
    logs: [],
    retryCount: 0,
    maxRetries: 3
  });
}
```

#### 3. í ìƒíƒœ ì²´í¬ (Line 1391-1417)

```typescript
// checkWaitingForUploadSchedules() ë‚´ë¶€
if (schedule.task_id) {
  const queueTask = await queueManager.getTask(schedule.task_id, 'image');

  if (queueTask) {
    if (queueTask.status === 'completed') {
      imageCrawlCompleted = true;
    } else if (queueTask.status === 'processing' || queueTask.status === 'waiting') {
      continue; // ì•„ì§ ì§„í–‰ ì¤‘
    }
  }
}

// í´ë” ê²½ë¡œ (task_id ê¸°ë°˜)
const taskFolderPath = path.join(BACKEND_PATH, 'input', `task_${schedule.task_id}`);
```

### ğŸ“Š ìƒíƒœ ì „ì´ ë‹¤ì´ì–´ê·¸ë¨

```
task_schedules.status:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ pending â”‚ â”€â”€â–¶ â”‚ processing â”‚ â”€â”€â–¶ â”‚ waiting_for_uploadâ”‚ â”€â”€â–¶ â”‚ processing â”‚ â”€â”€â–¶ â”‚ completed â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚                â”‚                     â”‚                       â”‚
     â–¼                â–¼                     â–¼                       â–¼
task_id ìƒì„±   (ëŒ€ë³¸ ìƒì„± ì¤‘)        (ì´ë¯¸ì§€ í¬ë¡¤ë§ ëŒ€ê¸°)      (ì˜ìƒ/ì—…ë¡œë“œ ì¤‘)

tasks_queue.status (task_id ê¸°ë°˜, typeë³„ ìƒíƒœ):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ task_id: "task_1234567890_abc123"                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ script  â”‚ completed  â”‚ âœ…        â”‚ ëŒ€ë³¸ ìƒì„± ì™„ë£Œ                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ image   â”‚ processing â”‚ ğŸ”„        â”‚ ì´ë¯¸ì§€ í¬ë¡¤ë§ ì¤‘                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ video   â”‚ waiting    â”‚ â³        â”‚ ì˜ìƒ ìƒì„± ëŒ€ê¸° (image ì™„ë£Œ í•„ìš”)        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ youtube â”‚ waiting    â”‚ â³        â”‚ YouTube ì—…ë¡œë“œ ëŒ€ê¸° (video ì™„ë£Œ í•„ìš”)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ğŸ”‘ í•µì‹¬ íŠ¹ì§•

1. **task_id í†µì¼**: ì „ì²´ íŒŒì´í”„ë¼ì¸ì„ ë‹¨ì¼ IDë¡œ ê´€ë¦¬ (í´ë”, DB ëª¨ë‘ ë™ì¼)
2. **ë‹¨ê³„ë³„ ì˜ì¡´ì„±**: ì´ì „ ë‹¨ê³„ ì™„ë£Œ ì‹œì—ë§Œ ë‹¤ìŒ ë‹¨ê³„ dequeue ê°€ëŠ¥
3. **íƒ€ì…ë³„ 1ê°œ ì²˜ë¦¬**: ê° íƒ€ì…(script, image, video, youtube)ë³„ ë™ì‹œ 1ê°œë§Œ ì‹¤í–‰
4. **í´ë°± ì§€ì›**: í ìƒíƒœ í™•ì¸ ì‹¤íŒ¨ ì‹œ í´ë” ì§ì ‘ ì²´í¬
5. **í´ë” êµ¬ì¡°**: `task_{task_id}/` (ì´ì „: `project_{script_id}/`)

### ğŸ“ ê´€ë ¨ íŒŒì¼

| íŒŒì¼ | ì—­í•  |
|------|------|
| `src/lib/queue-manager.ts` | í ê´€ë¦¬ í´ë˜ìŠ¤ (470+ lines) |
| `src/lib/automation-scheduler.ts` | ìŠ¤ì¼€ì¤„ëŸ¬ + Phase 4 í†µí•© (1800+ lines) |
| `src/lib/automation.ts` | DB ìŠ¤í‚¤ë§ˆ + í—¬í¼ í•¨ìˆ˜ |
| `src/workers/image-worker.ts` | ì´ë¯¸ì§€ í¬ë¡¤ë§ ì›Œì»¤ |
| `src/app/api/queue/*` | í ê´€ë¦¬ API ì—”ë“œí¬ì¸íŠ¸ |

### ğŸš€ ì›Œì»¤ ì‹¤í–‰

```bash
# ì´ë¯¸ì§€ í¬ë¡¤ë§ ì›Œì»¤ ì‹¤í–‰ (í•„ìˆ˜!)
npm run worker:image
```

**ìƒíƒœ**: âœ… ì™„ë£Œ (Phase 4 ìë™í™” í†µí•©)

---

## ê¸°íƒ€ ê¸°ëŠ¥

(ì¶”ê°€ ê¸°ëŠ¥ì€ ì—¬ê¸°ì— ì‘ì„±)
